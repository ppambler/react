### âœï¸ Tangxt â³ 2021-03-26 ğŸ·ï¸ Mobx

# Mobx åº”ç”¨

mobx æ˜¯ä¸€ä¸ªç®€å•å¯æ‰©å±•çš„çŠ¶æ€ç®¡ç†åº“

## â˜…mobx vs redux

mobx å­¦ä¹ æˆæœ¬æ›´ä½ï¼ˆå¯¹æ¯” redux è¦å­¦ 16 å°æ—¶ï¼Œmobx åªéœ€å­¦ä¸¤å°æ—¶å°±èƒ½ä¸Šæ‰‹åšé¡¹ç›®äº†ï¼‰ï¼Œæ€§èƒ½æ›´å¥½çš„çŠ¶æ€è§£å†³æ–¹æ¡ˆ

æ€»ä¹‹ï¼Œmobxï¼š

- å¼€å‘éš¾åº¦ä½
- å¼€å‘ä»£ç é‡å°‘
- æ¸²æŸ“æ€§èƒ½å¥½
  - çŠ¶æ€å’Œç»„ä»¶ä¸€å¯¹ä¸€ï¼Œå¦‚çŠ¶æ€æ ‘å¯¹åº”ä¸‰ä¸ªç»„ä»¶ï¼Œå½“å‘ç”ŸçŠ¶æ€æ”¹å˜æ—¶ï¼Œåªä¼šæ¸²æŸ“é‚£ä¸ªå—çŠ¶æ€å½±å“çš„é‚£ä¸ªç»„ä»¶ï¼Œä¸å—å½±å“çš„ï¼Œåˆ™ä¸ä¼šæ¸²æŸ“ï¼

![æ¸²æŸ“æ€§èƒ½å¥½](assets/img/2021-03-26-20-18-01.png)

## â˜…æ ¸å¿ƒæ€æƒ³

çŠ¶æ€å˜åŒ–å¼•èµ·çš„å‰¯ä½œç”¨ï¼ˆå¦‚ UI æ›´æ–°ï¼‰åº”è¯¥è¢«è‡ªåŠ¨è§¦å‘

- åº”ç”¨é€»è¾‘åªéœ€è¦ä¿®æ”¹çŠ¶æ€æ•°æ®å³å¯ï¼ŒMobx ä¼šè‡ªåŠ¨æ¸²æŸ“ UIï¼Œæ— éœ€äººå·¥å¹²é¢„
- æ•°æ®å˜åŒ–åªä¼šæ¸²æŸ“å¯¹åº”çš„ç»„ä»¶
- React æä¾›ä¸€ä¸ªæŠŠåº”ç”¨ç¨‹åºçš„çŠ¶æ€æ¸²æŸ“æˆç»„ä»¶æ ‘çš„æœºåˆ¶ï¼Œå¹¶å¯¹è¿™é¢—ç»„ä»¶æ ‘è¿›è¡Œæ¸²æŸ“
- MobX æä¾›äº†å­˜å‚¨å’Œæ›´æ–°åº”ç”¨çŠ¶æ€çš„æœºåˆ¶ä»¥ä¾› React ä½¿ç”¨

![æ ¸å¿ƒæ€æƒ³](assets/img/2021-03-27-15-52-38.png)

![è‰å›¾](assets/img/2021-03-27-15-53-24.png)

React åˆ©ç”¨è™šæ‹Ÿ DOM æ¥ä¼˜åŒ– UI çš„æ¸²æŸ“ï¼Œä»¥å‡å°‘ DOM æ“ä½œæˆæœ¬ã€‚ MobX åˆ™æä¾›äº†ä¼˜åŒ–å°†åº”ç”¨çŠ¶æ€åŒæ­¥åˆ° React ç»„ä»¶å†…çš„æœºåˆ¶ï¼Œé€šè¿‡ä½¿ç”¨äº†ä¸€ç§å“åº”å¼çš„çŠ¶æ€ä¾èµ–å›¾ï¼Œè¯¥ä¾èµ–å›¾ä¸¥æ ¼**åªåœ¨éœ€è¦çš„æ—¶å€™æ›´æ–°**ï¼Œå¹¶ä¸”ä¸ä¼šå‡ºç°ä»£ç è…åŒ–ã€‚

## â˜…ç¯å¢ƒå‡†å¤‡

### <mark>1ï¼‰å®‰è£…ä¾èµ–æ¨¡å—</mark>

![å®‰è£…ä¾èµ–æ¨¡å—](assets/img/2021-03-27-16-54-54.png)

``` bash
mkdir xxx
cd xxx
yarn init -y
yarn add webpack webpack-cli babel-core babel-loader babel-preset-env babel-preset-react babel-preset-stage-0 babel-plugin-transform-decorators-legacy react mobx mobx-react
```

> éœ€è¦å®‰è£…`react`

### <mark>2ï¼‰webpack.config.js</mark>

![é…ç½®](assets/img/2021-03-27-20-10-53.png)

### <mark>3ï¼‰package.json</mark>

``` json
{
  "scripts": {
    "start": "webpack --mode development -w"
  }
}
```

### <mark>4ï¼‰æµ‹è¯•</mark>

1. åˆ›å»ºä¸€ä¸ª`src/index.js`
2. `yarn start` -> åœ¨æ ¹ç›®å½•ä¸‹å‡ºç°ä¸€ä¸ª`build`ç›®å½•
   1. æ·»åŠ ä¸€ä¸ª`index.html`ï¼ˆå†™ä¸ª`<div id="root"></div>`å°±è¡Œäº†ï¼‰ï¼Œå¼•å…¥æ‰“åŒ…ç”Ÿæˆçš„`bundle.js`
   2. ç”¨ VS Code æä¾›çš„ `live server` åŠŸèƒ½æ‰“å¼€è¿™ä¸ª`index.html`

> è§†é¢‘æ˜¯ 18 å¹´ 3 æœˆä»½çš„ï¼Œç”¨äº† webpack5 åï¼Œå®‰è£…çš„ä¾èµ–åŒ…å¾—æ”¹äº†ï¼ -> webpack é…ç½®ä¹Ÿè¦æ”¹ -> æˆ‘æ²¡æœ‰é…ç½®`stage-0`ï¼Œä¼¼ä¹ babel7 åï¼Œè¿™ä¸ªé…ç½®å°±å–æ¶ˆäº†ï¼ -> è¿™ä¸ªé…ç½®ä»…ä»…æ˜¯æ‰“åŒ… JS æ–‡ä»¶

## â˜…Decorator

### <mark>1ï¼‰ç±»çš„ä¿®é¥°</mark>

- ä¿®é¥°å™¨ï¼ˆDecoratorï¼‰å‡½æ•°ï¼Œç”¨æ¥ä¿®é¥°ç±»çš„è¡Œä¸º
- ä¿®é¥°å™¨æ˜¯ä¸€ä¸ªå¯¹ç±»è¿›è¡Œå¤„ç†çš„å‡½æ•°ã€‚ä¿®é¥°å™¨å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå°±æ˜¯æ‰€è¦ä¿®é¥°çš„ç›®æ ‡ç±»
- ä¿®é¥°å™¨æœ¬è´¨å°±æ˜¯ç¼–è¯‘æ—¶æ‰§è¡Œçš„å‡½æ•°
- å¦‚æœæƒ³æ·»åŠ å®ä¾‹å±æ€§ï¼Œå¯ä»¥é€šè¿‡ç›®æ ‡ç±»çš„`prototype`å¯¹è±¡æ“ä½œ

> è¯»ä¿®é¥°å™¨è¿˜æ˜¯è£…é¥°å™¨ï¼Œéƒ½éšä½ 

è£…é¥°å™¨çš„è®¾è®¡ç†å¿µï¼š

![è®¾è®¡ç†å¿µ](assets/img/2021-03-27-20-25-20.png)

åœ¨ä¸æ”¹é€  **æ‰˜å°¼Â·å²å¡”å…‹ï¼ˆTony Starkï¼‰** æœ¬ä½“çš„å‰æä¸‹ï¼Œé€šè¿‡åŠ è£…**ç›”ç”²ã€é£è¡Œå™¨**çš„æ–¹å¼å¢å¼º Tony çš„èƒ½åŠ›ï¼Œä»è€Œâ€œå˜æˆâ€é’¢é“ä¾ ã€‚ -> ç»„åˆå¤§äºç»§æ‰¿

ä¾‹å­ï¼š

![ä¾‹å­](assets/img/2021-03-29-18-17-31.png)

åŸç†ï¼š

``` js
// ä¿®æ”¹äº† Person è¿™ä¸ªç±»çš„è¡Œä¸ºï¼Œå¢åŠ äº†æƒŠé™æ€å±æ€§ isTestable
function testable(target) {
  target.isTestable = true
}

// @testable
class Person {

}
// å°±æ˜¯è°ƒç”¨äº†å‡½æ•°
testable(Person)

console.log(Person.isTestable) // true
```

### <mark>2ï¼‰ä¿®é¥°å±æ€§</mark>

éœ€æ±‚ï¼šç»™ä¸€ä¸ªå«`Circle`ç±»çš„ä¸œè¥¿æ·»åŠ ä¸€ä¸ªå®ä¾‹å±æ€§`PI`ï¼Œè¦æ±‚è¿™ä¸ªå±æ€§ã€Œåªè¯»çš„ã€ï¼Œæ¯•ç«Ÿ`PI`æ˜¯æ’å®šçš„ï¼

``` js
// targetï¼šç›®æ ‡çš„åŸå‹ï¼Œå³å‡½æ•°çš„åŸå‹ -> keyï¼šç±»çš„å±æ€§ -> descriptorï¼šæè¿°å™¨
function readonly(target,key,descriptor) {
  console.log(target,key)
  console.log(descriptor)
  descriptor.writable = false
}
class Circle {
  // è¿™æ˜¯å®ä¾‹çš„å±æ€§
  @readonly PI = 3.14
  computed() {

  }
}
let c1 = new Circle()
// è§†é¢‘é‡Œæ˜¯æŠ¥äº† Cannot assign to read only property 'PI' of object è¿™æ ·çš„é”™è¯¯
// è‡ªå·±æœ¬åœ°æµ‹è¯•æ²¡æœ‰æŠ¥é”™ï¼Œä½†æ˜¯èµ·äº†æ•ˆæœ
c1.PI = 3.15
console.log(c1.PI) // 3.14
```

![å®ä¾‹å±æ€§](assets/img/2021-03-29-20-32-14.png)

ğŸ’¡ï¼šåœ¨ VS Code é‡Œè¾¹ï¼Œ`PI` ä¼šæœ‰è­¦å‘Šï¼Ÿ

é…ç½® `jsconfig.json` ï¼š

``` json
{
  "compilerOptions": {
    "experimentalDecorators": true
  }
}
```

ğŸ’¡ï¼šæè¿°å™¨ï¼ˆdescriptorï¼Œä¹Ÿå«å±æ€§æè¿°ç¬¦ï¼‰æ˜¯ä»€ä¹ˆï¼Ÿ

``` js
Object.defineProperty(obj, prop, descriptor)
```

æˆ‘ä»¬å¯ä»¥è¿™æ ·ç»™ä¸€ä¸ªå¯¹è±¡å®šä¹‰å±æ€§ï¼š

``` js
let obj = {}
obj.name = 'xxx'
```

ä¹Ÿå¯ä»¥è¿™æ ·ï¼š

``` js
Object.defineProperty(obj,'age',{
  value: 666, // å®é™…çš„å€¼
  enumerable: false, // æ˜¯å¦å¯æšä¸¾ -> å¯ä»¥ç”¨ for in å¾ªç¯å—ï¼Ÿ
  writable: true, // æ˜¯å¦å¯ä¿®æ”¹
  configurable: false // æ˜¯å¦å¯é…ç½® -> å¯ä»¥åˆ é™¤è¿™ä¸ªå±æ€§é…ç½®å—ï¼Ÿ -> delete obj.age
})

console.log(obj.age) // 666
obj.age = 777
console.log(obj.age) // 777

for (const key in obj) {
  console.log(key) // åª log äº†ä¸€ä¸ª name å±æ€§
}

delete obj.age
console.log(obj.age) // 777
```

ç¬¬ä¸€ç§å§¿åŠ¿å…¶å®å°±æ˜¯ç¬¬äºŒç§å§¿åŠ¿çš„ç®€å†™ï¼Œåªæ˜¯å®ƒé»˜è®¤å°±æ˜¯å¯å†™çš„ã€å¯æšä¸¾çš„ï¼Œä»¥åŠå¯é…ç½®çš„ï¼

é¢˜å¤–è¯ï¼Œå…¶å®ï¼Œå±æ€§æè¿°ç¬¦`descriptor`æ€»å…±åˆ†ä¸ºä¸¤ç§å½¢å¼ï¼š

1. æ•°æ®æè¿°ç¬¦ï¼ˆData descriptorï¼‰
2. è®¿é—®å™¨æè¿°ç¬¦ï¼ˆAccessor descriptorï¼‰

æ³¨æ„

æˆ‘ä»¬ä¸Šè¾¹é‚£ç§å½¢å¼å°±æ˜¯æŠŠ`descriptor`å½“ä½œæ˜¯ã€Œæ•°æ®æè¿°ç¬¦ã€æ¥è¡¨ç°ï¼š

``` js
const res = Object.getOwnPropertyDescriptor(obj,'age');
console.log(res) // { value: 777, writable: true, enumerable: false, configurable: false }
```

è€Œã€Œè®¿é—®å™¨æè¿°ç¬¦ã€ï¼ˆä¹Ÿå¯ä»¥å«å­˜å–æè¿°ç¬¦ï¼‰çš„å½¢å¼å°±æ˜¯åœ¨ä¸€ä¸ªçš„å¯¹è±¡é‡Œè¾¹ç”¨`get/set`

æ³¨æ„ -> **æè¿°ç¬¦å¿…é¡»æ˜¯ä¸¤ç§å½¢å¼ä¹‹ä¸€ï¼Œä¸èƒ½åŒæ—¶æ˜¯ä¸¤è€…**

![æè¿°ç¬¦](assets/img/2021-03-29-19-04-32.png)

### <mark>3ï¼‰ä¿®é¥°æ–¹æ³•</mark>

ä¿®é¥°å™¨ä¸ä»…å¯ä»¥ä¿®é¥°ç±»ï¼Œè¿˜å¯ä»¥ä¿®é¥°ç±»çš„å±æ€§å’Œæ–¹æ³•

ä¾‹å­ï¼šæ‰“å°å‡½æ•°è°ƒç”¨æ—¥å¿—

``` js
class Calculator {
  @logger
  add(a,b) {
    return a+b
  }
}

function logger(target,name,descriptor) {
  let oldVal = descriptor.value
  descriptor.value = function() {
    console.log(`${name}(${Array.from(arguments).join(',')})`)
    return oldVal.apply(this,arguments)
  }
}

let c = new Calculator()
let res = c.add(1,2)
console.log(res) // add(1,2) -> 3
```

åŸç†ï¼š

![åŸç†](assets/img/2021-03-30-00-10-48.png)

``` js
let oldDescriptor = Object.getOwnPropertyDescriptor(Calculator.prototype,'add')
logger(Calculator.prototype,'add',oldDescriptor)
Object.defineProperty(Calculator.prototype,'add',oldDescriptor)
```

ğŸ’¡ï¼šä¸ºå•¥æˆ‘å®šä¹‰åœ¨å®ä¾‹å±æ€§ä¸Šï¼Œè¿™`target`å±…ç„¶ä¹Ÿæ˜¯åŸå‹å¯¹è±¡å‘¢ï¼ŸæŒ‰ç†è¯´ä¸åº”è¯¥æ˜¯å®ä¾‹å—ï¼Ÿ

![å®ä¾‹å±æ€§](assets/img/2021-03-30-00-19-13.png)

ä¹Ÿè®¸ï¼Œå®˜æ–¹çº¦å®šäº†ï¼Œä¼ çš„å°±æ˜¯åŸå‹å±æ€§ï¼Œè€Œä¸æ˜¯å®ä¾‹å¯¹è±¡ï¼

è¯è¯´ï¼Œå¦‚æœ`add`æ˜¯ä¸ªå®ä¾‹æ–¹æ³•ï¼Œè€Œä¸”å®ƒæ˜¯ä¸ªç®­å¤´å‡½æ•°ï¼Œè¿™åˆä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿ

å¦‚ï¼š

``` js
class Calculator {
  @logger
  add = (a, b) => {
    return a + b;
  };
  // @test
  name = "c";
}
```

æˆ‘æµ‹è¯•äº†ä¸€ä¸‹ï¼Œ`descriptor.value`çš„å€¼æ˜¯`undefined`ï¼Œä½ å¾—é€è¿‡`descriptor.initializer()`æ¥è·å–`add`æ–¹æ³•ï¼Œæœ€ç»ˆä»£ç ï¼š

``` js
function logger(target, name, descriptor) {
  console.log(target, name);
  console.log(descriptor);
  console.log(descriptor.initializer());
  // let oldVal = descriptor.value;
  // console.log(oldVal); // undefined
  let oldVal = descriptor.initializer();
  function _oldVal() {
    console.log(`${name}(${Array.from(arguments).join(',')})`)
    return oldVal.apply(this,arguments)
  }
  descriptor.initializer = function initializer() {
    return _oldVal
  }
}
```

æ•ˆæœï¼š

![æ•ˆæœ](assets/img/2021-03-30-01-13-38.png)

### <mark>4ï¼‰å°ç»“</mark>

- å¤§éƒ¨åˆ†éœ€æ±‚éƒ½æ˜¯åœ¨å¤„ç†`descriptor`
- è£…é¥°åœ¨åŸå‹æ–¹æ³•è¿˜æ˜¯å®ä¾‹å±æ€§/æ–¹æ³•ï¼Œå…¶ç¬¬ä¸€ä¸ªå‚æ•°çš„å€¼éƒ½æ˜¯åŸå‹å¯¹è±¡å•Šï¼è£…é¥°åœ¨ç±»ä¸Šåˆ™æ˜¯ç±»æœ¬èº«ï¼
- å†™ä¸Šäº†è£…é¥°å™¨ï¼Œæ„å‘³ç€ä¼šè‡ªåŠ¨æ‰§è¡Œè¿™ä¸ªè£…é¥°å™¨æ–¹æ³• -> è¢«è£…é¥°äº†çš„ä¸œè¥¿ï¼Œä½ è¯¥æ€ä¹ˆç”¨è¿˜æ˜¯æ€ä¹ˆç”¨ï¼Œåªæ˜¯å¤šäº†ä¸€äº›ä¸æ˜è§‰å‰çš„èƒ½åŠ›çš„ç½¢äº†ï¼

## â˜…Proxy

- Proxy å¯ä»¥ç†è§£æˆï¼Œåœ¨ç›®æ ‡å¯¹è±¡ä¹‹å‰æ¶è®¾ä¸€å±‚ã€Œæ‹¦æˆªã€ï¼Œå¤–ç•Œå¯¹è¯¥å¯¹è±¡çš„è®¿é—®ï¼Œéƒ½å¿…é¡»å…ˆé€šè¿‡è¿™å±‚æ‹¦æˆªï¼Œå› æ­¤æä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œå¯ä»¥å¯¹å¤–ç•Œçš„è®¿é—®è¿›è¡Œè¿‡æ»¤å’Œæ”¹å†™
- `get`æ–¹æ³•ç”¨äºæ‹¦æˆªæŸä¸ªå±æ€§çš„è¯»å–æ“ä½œï¼Œå¯ä»¥æ¥å—**ä¸‰ä¸ªå‚æ•°**ï¼Œä¾æ¬¡ä¸ºã€Œç›®æ ‡å¯¹è±¡ã€ã€ã€Œå±æ€§åã€å’Œã€Œ`Proxy`å®ä¾‹æœ¬èº«ã€
- `set`æ–¹æ³•ç”¨æ¥æ‹¦æˆªæŸä¸ªå±æ€§çš„èµ‹å€¼æ“ä½œï¼Œå¯ä»¥æ¥å—**å››ä¸ªå‚æ•°**ï¼Œä¾æ¬¡ä¸ºã€Œç›®æ ‡å¯¹è±¡ã€ã€ã€Œå±æ€§åã€ã€ã€Œå±æ€§å€¼ã€å’Œã€Œ`Proxy`å®ä¾‹æœ¬èº«ã€

``` js
let proxy = new Proxy(target,handler)
```

``` js
let p1 = new Proxy({name:'xxx'},{
  get(target,key,receiver) {
    console.log(`getting ${key}`)
    console.log(receiver)
    return Reflect.get(target,key,receiver)
  },
  set(t,k,value,r) {
    console.log(`setting ${key}`)
    return Reflect.set(t,k,value,r)
  }
})

console.log(p1.name)
// getting name
// { name: 'xxx' }
// xxx
```

> `receiver`å°±æ˜¯`p1` -> è¿™æ˜¯ä¸ªæ²¡å•¥ç”¨çš„å‚æ•°

ğŸ’¡ï¼šReflectï¼Ÿ

`Reflect` æ˜¯ä¸€ä¸ªå†…ç½®çš„å¯¹è±¡ï¼Œå®ƒæä¾›æ‹¦æˆª JavaScript æ“ä½œçš„æ–¹æ³•ã€‚`Reflect` ä¸æ˜¯ä¸€ä¸ªå‡½æ•°å¯¹è±¡ï¼Œå› æ­¤å®ƒæ˜¯ä¸å¯æ„é€ çš„ã€‚`Reflect` çš„æ‰€æœ‰çš„æ–¹æ³•éƒ½æ˜¯é™æ€çš„å°±å’Œ `Math` ä¸€æ ·ï¼Œç›®å‰å®ƒè¿˜æ²¡æœ‰é™æ€å±æ€§ã€‚

`Reflect` å¯¹è±¡çš„æ–¹æ³•ä¸ `Proxy` å¯¹è±¡çš„æ–¹æ³•ç›¸åŒã€‚

`Reflect` ä¸€å…±æœ‰ 13 ä¸ªé™æ€æ–¹æ³•ï¼Œå®ƒå¯ä»¥åˆ†ä¸ºï¼š

- ä¸€éƒ¨åˆ†æ˜¯æ˜¯åŸæ¥å­˜åœ¨ `Object` ä¸Šçš„æ–¹æ³•ï¼Œå°†å®ƒè½¬ä¹‰åˆ°äº† `Reflect` ä¸Šï¼Œå¹¶ä½œäº†å°æ”¹åŠ¨ï¼Œè®©æ–¹æ³•æ›´åŠ åˆç†ï¼Œå¦‚`defineProperty`ã€`getOwnPropertyDescriptor`
- å¦ä¸€éƒ¨åˆ†æ˜¯å°†åŸæ¥æ“ä½œç¬¦çš„åŠŸèƒ½ï¼Œå˜æˆå‡½æ•°è¡Œä¸ºï¼Œå¦‚`in -> has(target, key)`ã€`delete -> deleteProperty(target, key)`

ä¸ºä»€ä¹ˆéœ€è¦`Reflect`è¿™ä¸ªä¸œè¥¿ï¼Ÿï¼ˆäº§ç”Ÿçš„èƒŒæ™¯å’Œå¿…è¦æ€§ï¼‰

> å› ä¸º proxy ä»£ç†ä¸äº†ä¸€äº› Mapã€Set ä¹‹ç±»çš„å±æ€§ï¼Œä½†æ˜¯ Proxy ä¸ºå®ƒä»¬æä¾›äº†é»˜è®¤çš„æ’æ§½ è¿™æ—¶å€™ Reflect å°±èƒ½æ´¾ä¸Šç”¨åœºäº†

ä¾‹å­ï¼š

`Reflect.get ( target, propertyKey [ , receiver ])` -> è¯¥æ–¹æ³•ç”¨æ¥è·å–å¯¹è±¡ä¸­æŸä¸ªå±æ€§ï¼Œå¦‚ï¼š

``` js
const testObject = {
  a: 'you',
  b: 'like'
}
Reflect.get(testObject, 'a') === 'you' // true
Reflect.get(testObject, 'b') === 'like' // true
```

`Reflect.set ( target, propertyKey, V [ , receiver ] )` -> è¯¥æ–¹æ³•ç”¨æ¥è®¾ç½®å¯¹è±¡ä¸­æŸä¸ªå±æ€§ï¼Œå¦‚ï¼š

``` js
const testObject = {
  a: 'you',
  b: 'like'
}
Reflect.set(testObject, 'c', 'javascript') // true
Reflect.get(testObject, 'c') === 'javascript' // true
```

æ€»ä¹‹ï¼Œä¸Šè¾¹çš„`Proxy`è¿”å›ä¸€ä¸ª`return Reflect.set(t,k,value,r)`ï¼Œæ„å‘³ç€ä¸ä½¿ç”¨èµ‹å€¼è¯­å¥äº†ï¼

â¹ï¼š[JS ä¸­çš„ Reflect å’Œ Proxy](https://juejin.cn/post/6844903790739456013)

â¹ï¼š[JS çš„ Reflect å­¦ä¹ å’Œåº”ç”¨ - çŸ¥ä¹](https://zhuanlan.zhihu.com/p/92700557)

ğŸ’¡ï¼šè€å¸ˆçš„æ—¥å¸¸ç¬”è®°ç›®å½•ï¼Ÿ

![ç¬”è®°ç›®å½•](assets/img/2021-04-01-14-29-35.png)

## â˜…Mobx

### <mark>1ï¼‰observable</mark>

- Mobx ä¸ºç°æœ‰çš„æ•°æ®ç»“æ„ï¼ˆå¦‚å¯¹è±¡ã€æ•°ç»„ã€ç±»å®ä¾‹ã€å­—ç¬¦ä¸²ã€æ•°å€¼ç­‰ï¼‰æ·»åŠ äº†å¯è§‚å¯Ÿçš„åŠŸèƒ½
- `observable`å°±æ˜¯ä¸€ç§è®©æ•°æ®çš„å˜åŒ–å¯ä»¥è¢«è§‚å¯Ÿçš„æ–¹æ³•
- å…ˆæŠŠæ•°æ®è½¬åŒ–æˆå¯ä»¥è¢«è§‚å¯Ÿçš„å¯¹è±¡ï¼Œé‚£ä¹ˆå¯¹è¿™äº›æ•°æ®çš„ä¿®æ”¹å°±å¯ä»¥è¢«ç›‘è§†

#### <mark>1ã€å¼•ç”¨ç±»å‹ï¼ˆobservableï¼‰</mark>

> å¯¹è±¡ã€æ•°ç»„

``` js
import { observable } from "mobx";

let o1 = observable({ name: "frank" });
console.log(o1.name);

let arr1 = observable([1, 2, 3]);
console.log(arr1);

arr1.pop();
arr1.push(4);
arr1.unshift(0);

console.log(arr1);
```

![observable](assets/img/2021-04-01-14-49-41.png)

> `observable`è¿”å›æ—¶ä¸€ä¸ª`Proxy`å®ä¾‹

éœ€æ±‚ï¼šæ”¹å˜æ•°æ®ï¼Œæ‰§è¡Œ`callback`

ä½¿ç”¨`observe`ï¼ˆåŠ¨è¯ï¼Œè§‚å¯Ÿï¼‰ï¼š

![observe](assets/img/2021-04-01-14-55-05.png)

#### <mark>2ã€ç®€å•ç±»å‹ï¼ˆåŸºæœ¬ç±»å‹ï¼‰</mark>

> å­—ç¬¦ä¸²ã€å¸ƒå°”å€¼ã€æ•°å­—ã€Symbolï¼ˆç‹¬ä¸€æ— äºŒçš„å€¼ï¼‰

![ç®€å•ç±»å‹](assets/img/2021-04-01-15-34-30.png)

#### <mark>3ã€decorator</mark>

å¯¹äºå­˜æœ‰åŸºæœ¬ç±»å‹å€¼çš„å±æ€§ï¼Œä¸éœ€è¦å†™æˆ`@observable.box`è¿™æ ·ï¼Œç›´æ¥`@observable age = 18`è¿™æ ·å°±å¥½äº†ï¼Œ`observable`å†…éƒ¨è‡ªå·±å¸®æˆ‘ä»¬å°è£…äº†ï¼

Mobx6 ä¹‹å‰çš„åšæ³•ï¼š

``` js
import { observable, observe } from "mobx";
class Person {
  @observable name = "frank";
  @observable age = 18;
  @observable isMarried = false;
  @observable hobby = ["æ•²ä»£ç ", "æ‰“ LOL", "ç¡è§‰"];
  @observable home = { name: "æµ·å²›" };
  @observable skills = new Map();
}

let p = new Person()
observe(p,(c)=>{
  console.log(c)
})
console.log(p)
p.age = 19
p.name = 'xxx'
p.hobby.push('ç©è€')
p.home.name = 'æ¤°å²›'
```

Mobx6 ä¸è¦ `decorator` äº†ï¼š

``` js
import { makeAutoObservable,observe } from "mobx"
class Person {
  name = "frank";
  age = 18;
  isMarried = false;
  hobby = ["æ•²ä»£ç ", "æ‰“ LOL", "ç¡è§‰"];
  home = { name: "æµ·å²›", number: '101'};
  skills = new Map();
  constructor() {
    makeAutoObservable(this)
  }
}

let p = new Person()
// p å®ä¾‹æ——ä¸‹çš„å±æ€§æ”¹å˜äº†ï¼Œéƒ½ä¼šæ‰§è¡Œè¿™ä¸ª callback
observe(p,(c)=>{
  console.log(c)
})
// p å®ä¾‹çš„ name å±æ€§æ”¹å˜äº†ï¼Œå°±ä¼šæ‰§è¡Œè¿™ä¸ª callback
observe(p,'name',(c)=>{
  console.log(c)
})

console.log(p) // å®ä¾‹çš„è‡ªæœ‰å±æ€§éƒ½è¢« getã€set äº†ï¼Œå³éƒ½è¢«ç›‘å¬äº†
p.age = 19
p.name = 'xxx'
// p.hobby.push('ç©è€')
// p.home.name = 'æ¤°å²›'
// éµå®ˆæ•°æ®ä¸å¯å˜ç†å¿µ
p.hobby = [...p.hobby,'ç©è€']
p.home = {...p.home,name:'æ¤°å²›'}
console.log(p.hobby[3]) // ç©è€
console.log(p.home.name) // æ¤°å²›
console.log(p.home.number) // 101
```

![mobx6 ç”¨æ³•](assets/img/2021-04-03-18-29-13.png)

> åœ¨é…åˆ React ä½¿ç”¨æ—¶ï¼Œ`observe`è¿™ä¸ªæ“ä½œå¯¹åº”çš„æ˜¯`mobx-react`é‡Œè¾¹çš„`observer`

å†çœ‹é‚£å¼ å›¾ï¼š

![å†çœ‹é‚£å¼ å›¾](assets/img/2021-04-03-18-36-46.png)

â¹ï¼š[Mobx çœŸçš„å¥½ç”¨å—ï¼Ÿå®ƒæœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼Ÿä¸»è¦é€‚ç”¨äºä»€ä¹ˆåœºæ™¯ï¼Ÿ - çŸ¥ä¹](https://www.zhihu.com/question/328612405)

â¹ï¼š[mobx6.0 ä¸ºä»€ä¹ˆç§»é™¤è£…é¥°å™¨ - çŸ¥ä¹](https://zhuanlan.zhihu.com/p/342648174)

ğŸ’¡ï¼šå¦‚æœæˆ‘éå¾—è¦åœ¨ Mobx6 é‡Œè¾¹ä½¿ç”¨è£…é¥°å™¨æ¨¡å¼å‘¢ï¼Ÿ

é‚£ä¹ˆä½ å¾—è¿™æ ·åšï¼š

``` js
import { makeObservable,observable, observe } from "mobx";
class Person {
  @observable name = "frank";
  @observable age = 18;
  @observable isMarried = false;
  @observable hobby = ["æ•²ä»£ç ", "æ‰“ LOL", "ç¡è§‰"];
  @observable home = { name: "æµ·å²›" };
  @observable skills = new Map();
  constructor() {
    makeObservable(this)
  }
}

let p = new Person()
observe(p,(c)=>{
  console.log(c)
})
console.log(p)
p.age = 19
p.name = 'xxx'
```

å³æ·»åŠ `makeObservable`å°±è¡Œäº†ï¼

ä½†è¿™çœ‹èµ·æ¥å¾ˆæ²¡æœ‰å¿…è¦ï¼Œä¹Ÿè®¸è¿™æ˜¯ä¸ºäº†å…¼å®¹è€ç‰ˆæœ¬æ‰€æä¾›çš„ä¸€ä¸ªå¼€å…³æŒ‰é’®å§ï¼

## â˜…ä½¿ç”¨å¯¹å¯è§‚å¯Ÿå¯¹è±¡åšå‡ºå“åº”

> å¦‚æœä½ æœ‰ä¸€ä¸ªå±æ€§æ˜¯ç®—å‡ºæ¥çš„ï¼Œé‚£ä½ å°±ç”¨`computed`å‘—ï¼

### <mark>1ï¼‰computed</mark>

* è®¡ç®—å€¼ (computed values) æ˜¯å¯ä»¥æ ¹æ®ç°æœ‰çš„çŠ¶æ€æˆ–å…¶å®ƒè®¡ç®—å€¼è¡ç”Ÿå‡ºçš„å€¼
* ç»„åˆå·²æœ‰çš„å¯è§‚å¯Ÿæ•°æ®ï¼Œæˆä¸ºæ–°çš„å¯è§‚å¯Ÿæ•°æ®
* æ—¢æ˜¯ååº”åˆæ˜¯å¯è§‚å¯Ÿæ•°æ®
* å¯ä»¥ä½œä¸ºå‡½æ•°ä½¿ç”¨ä¹Ÿå¯ä»¥ä½œä¸º `decorator` ä½¿ç”¨
* ä½¿ç”¨ `.get()` æ¥è·å–è®¡ç®—çš„å½“å‰å€¼
* ä½¿ç”¨ `.observe(callback)` æ¥è§‚å¯Ÿå€¼çš„æ”¹å˜ã€‚
* `computed` å€¼å¯ä»¥å¼•ç”¨å…¶å®ƒ `computed` çš„å€¼ï¼Œä½†æ˜¯ä¸èƒ½å¾ªç¯å¼•ç”¨

ç¤ºä¾‹ï¼š

![computed](assets/img/2021-04-04-10-05-15.png)

å…¶å®ï¼Œæˆ‘æŠŠ`@computed`å»æ‰ï¼Œç»“æœä¹Ÿæ˜¯ä¸€æ ·çš„ï¼ -> `phone`æ˜¯ä¸ªè®¿é—®å™¨å±æ€§å•Šï¼

éš¾é“åªæ˜¯ä¸ºäº†ä¿®é¥°å®ƒæ˜¯ä¸€ä¸ªè®¡ç®—å±æ€§å—ï¼Ÿ

ğŸ’¡ï¼šå¦‚ä½•ç›‘å¬è®¡ç®—å±æ€§çš„å˜åŒ–ï¼Œç„¶ååšç‚¹ä»€ä¹ˆå‘¢ï¼Ÿ

![è®¿é—®å™¨å±æ€§](assets/img/2021-04-04-10-21-27.png)

æ•ˆæœï¼š

![æ•ˆæœ](assets/img/2021-04-04-10-26-10.png)

æ³¨æ„ï¼šå¦‚æœä½ ç”¨äº†`@observable`ä¿®é¥°è®¿é—®å™¨å±æ€§ï¼Œé‚£ä¹ˆä¼šæŠ¥`'observable' cannot be used on getter/setter properties`çš„é”™è¯¯

ğŸ’¡ï¼šæŠŠ`computed`ä½œä¸ºå‡½æ•°ä½¿ç”¨ï¼Ÿ

![ä½œä¸ºå‡½æ•°ä½¿ç”¨](assets/img/2021-04-04-10-47-00.png)

ğŸ’¡ï¼š`autorun`ä¹Ÿå¯ä»¥èµ·åˆ°`observe`çš„ä½œç”¨ï¼Ÿ

![autorun](assets/img/2021-04-04-10-59-57.png)

ä½ æ”¹æˆè¿™æ ·ï¼š

``` js
autorun((c)=>{
  console.log(c) // Reaction å®ä¾‹
  console.log(p.age)
})
```

é‚£ä¹ˆ`p.age`æ”¹å˜äº†ï¼Œå°±ä¼š`autorun`ä¸€ä¸‹äº†ï¼

> è§†é¢‘é‡Œè¯´ç”¨`autorun`çš„åŸå› ï¼šä¸èƒ½`p.phone.observe()`è¿™æ · -> `p.phone`è¿”å›çš„å°±æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²äº†ï¼Œæ‰€ä»¥ç”¨`autorun`å°±èƒ½è§£å†³è¿™ä¸ªé—®é¢˜äº†ï¼

è¯è¯´ï¼Œ`observe`å’Œ`autorun`å·®åˆ«å¤§å—ï¼Ÿ

> `autorun(callback)`å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å°±å®ç°äº†çŠ¶æ€å˜åŒ–ï¼Œé‡æ–°æ¸²æŸ“ UIï¼ -> ç›‘å¬`callback`é‡Œç”¨åˆ°çš„çŠ¶æ€ï¼ŒçŠ¶æ€ä¸€æ—¦å˜åŒ–ï¼Œå°±ä¼šé‡æ–°`render` -> æˆ–è®¸æ˜¯`mobx-react`é‡Œçš„`observer`å®ç°åŸç†

### <mark>2ï¼‰autorun</mark>

* å¦‚æœä½¿ç”¨ä¿®é¥°å™¨æ¨¡å¼ï¼Œåˆ™ä¸èƒ½å†ç”¨`observe`æ–¹æ³•äº† -> è¿™é‡ŒæŒ‡çš„`p.phone.observe`å§¿åŠ¿ï¼
* å½“ä½ æƒ³åˆ›å»ºä¸€ä¸ªå“åº”å¼å‡½æ•°ï¼Œè€Œè¯¥å‡½æ•°æœ¬èº«æ°¸è¿œä¸ä¼šæœ‰è§‚å¯Ÿè€…æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ `mobx.autorun`
* å½“ä½¿ç”¨ `autorun` æ—¶ï¼Œæ‰€æä¾›çš„å‡½æ•°æ€»æ˜¯ç«‹å³è¢«è§¦å‘ä¸€æ¬¡ï¼Œç„¶åæ¯æ¬¡å®ƒçš„ä¾èµ–å…³ç³»æ”¹å˜æ—¶ä¼šå†æ¬¡è¢«è§¦å‘
* æ•°æ®æ¸²æŸ“åè‡ªåŠ¨æ¸²æŸ“

``` js
import { autorun, computed, makeObservable, observable } from "mobx";
class Store {
  constructor() {
    makeObservable(this);
  }
  @observable province = "å¹¿ä¸œ";
  @observable city = "å¹¿å·";
  @computed get home() {
    return this.province + this.city;
  }
}

let store = new Store();
autorun(() => {
  //console.log(store.province,store.city);
  console.log(store.home); // æ‰§è¡Œäº†ä¸‰æ¬¡ï¼Œå¹¿ä¸œå¹¿å·ï¼Œæ¹–å—å¹¿å·ï¼Œæ¹–å—é•¿æ²™
});

store.province = "æ¹–å—";
store.city = "é•¿æ²™";
```

æ³¨æ„ï¼šè®¡ç®—å±æ€§`home`ä¾èµ–çš„æœ¬è´¨æ˜¯`store.province`å’Œ`store.city`ï¼æˆ‘æŠŠä¸Šè¾¹é‚£ä¸ªæ³¨é‡Šç»™å–æ¶ˆæ‰äº†ï¼Œä¹Ÿæ˜¯æ‰§è¡Œäº†ä¸‰æ¬¡ï¼

### <mark>3ï¼‰when</mark>

> ä¸ºä»€ä¹ˆä¼šæœ‰å®ƒï¼Ÿ -> æœ‰æ—¶å€™éœ€è¦ç­‰åˆ°æŸä¸ªæ—¶é—´ç‚¹å†æ‰“å°ï¼ -> æœ‰ç‚¹åƒäº‹ä»¶çš„`once`

* when è§‚å¯Ÿå¹¶è¿è¡Œç»™å®šçš„ `predicate`ï¼Œç›´åˆ°è¿”å› trueã€‚
* ä¸€æ—¦è¿”å› `true`ï¼Œç»™å®šçš„ `effect` å°±ä¼šè¢«æ‰§è¡Œï¼Œç„¶å `autorunner`ï¼ˆè‡ªåŠ¨è¿è¡Œç¨‹åºï¼‰ ä¼šè¢«æ¸…ç†ã€‚ -> **åªæ‰§è¡Œä¸€æ¬¡**
* è¯¥å‡½æ•°è¿”å›ä¸€ä¸ªæ¸…ç†å™¨ä»¥æå‰å–æ¶ˆè‡ªåŠ¨è¿è¡Œç¨‹åºã€‚ -> **å¯ä»¥ä¸»åŠ¨å–æ¶ˆ**

è¯­æ³•ï¼š

``` ts
when(predicate: () => boolean, effect?: () => void, options?)
```

ç¤ºä¾‹ï¼š

``` js
import { makeObservable, observable, when } from "mobx";

class Person {
  @observable age = 18;
  constructor(age) {
    makeObservable(this);
    this.age = age;
  }
}

let boy = new Person(19);
let girl = new Person(18);

// when ä¼šç­‰å¾…æ¡ä»¶æ»¡è¶³ï¼Œä¸€æ—¦æ»¡è¶³å°±ä¼šæ‰§è¡Œå›è°ƒå¹¶é”€æ¯ç›‘å¬
// callback æ‰§è¡Œä¸€æ¬¡åå°±ä¸ä¼šåœ¨æ‰§è¡Œäº†ï¼Œå› ä¸ºç›‘å¬è¢«é”€æ¯äº†ï¼
when(
  () => {
    return boy.age >= 22 && girl.age >= 20;
  },
  () => {
    console.log(`ç”·${boy.age}`, `å¥³${girl.age}`);
    console.log("æˆ‘ä»¬å»é¢†ç»“å©šè¯å§ï¼");
  }
);

setInterval(() => {
  boy.age++;
  girl.age++;
}, 1000);
```

ä¸»åŠ¨å–æ¶ˆç›‘å¬ï¼š

``` js
// when å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªå–æ¶ˆç›‘å¬çš„å‡½æ•°ï¼Œå¦‚æœä½ è°ƒç”¨å®ƒï¼Œé‚£å°±ç›´æ¥å–æ¶ˆç›‘å¬äº†ï¼
// ç›¸å½“äºï¼Œä½  add äº†ï¼Œç´§æ¥ç€ä½ åˆ remove äº†ï¼Œç­‰äºç™½å¹²ï¼
let disposer = when(
  () => {
    return boy.age >= 22 && girl.age >= 20;
  },
  () => {
    console.log(`ç”·${boy.age}`, `å¥³${girl.age}`); // 22 20
    console.log("æˆ‘ä»¬å»é¢†ç»“å©šè¯å§ï¼"); // ...
  }
);
disposer()
```

### <mark>4ï¼‰reaction</mark>

> æœ€é‡è¦çš„ä¸€ä¸ª

- `autorun`çš„å˜ç§ï¼Œ`autorun`ä¼šè‡ªåŠ¨è§¦å‘ï¼Œ`reaction`å¯¹äºå¦‚ä½•è¿½è¸ª`observable`èµ‹äºˆäº†æ›´ç»†ç²’åº¦çš„æ§åˆ¶
- å®ƒæ¥æ”¶ä¸¤ä¸ªå‡½æ•°å‚æ•°ï¼Œç¬¬ä¸€ä¸ªï¼ˆ**æ•°æ®å‡½æ•°**ï¼‰æ˜¯ç”¨æ¥è¿½è¸ªå¹¶è¿”å›æ•°æ®ä½œä¸ºç¬¬äºŒä¸ªå‡½æ•°ï¼ˆ**æ•ˆæœå‡½æ•°**ï¼‰çš„è¾“å…¥
- ä¸åŒäº`autorun`çš„æ˜¯ï¼Œå½“åˆ›å»ºæ—¶ã€Œæ•ˆæœå‡½æ•°ã€ä¸ä¼šç›´æ¥è¿è¡Œï¼Œåªæœ‰åœ¨æ•°æ®è¡¨è¾¾å¼é¦–æ¬¡è¿”å›ä¸€ä¸ªæ–°å€¼åæ‰ä¼šè¿è¡Œ
- å¯ä»¥ç”¨åœ¨ç™»å½•ä¿¡æ¯å­˜å‚¨å’Œå†™ç¼“å­˜é€»è¾‘

ç¤ºä¾‹ï¼š

``` js
let boy = new Person(19);
let girl = new Person(18);
// arr -> [20,19]
reaction(
  () => [boy.age, girl.age],
  (arr) => console.log(arr)
);
setInterval(() => {
  boy.age++;
  girl.age++;
}, 1000);
```

æ³¨æ„ï¼š

1. ç»™ä¸€æ ·çš„å€¼æ˜¯ä¸ä¼šè§¦å‘çš„ï¼Œå¦‚`boy`çš„`age`é»˜è®¤å€¼æ˜¯`19`ï¼Œä½ `boy.age = 19`æ˜¯ä¸ä¼šè§¦å‘`callback`æ‰§è¡Œçš„ï¼
2. æ•°ç»„é‡Œè¾¹ä»»æ„ä¸€ä¸ªæ•°æ®æ”¹å˜éƒ½ä¼šè§¦å‘`callback`æ‰§è¡Œ -> è¿™æœ‰ç‚¹åƒ`useEffect`å•Šï¼
3. `when`å’Œ`reaction`åŒæ—¶å­˜åœ¨ï¼Œéƒ½æ»¡è¶³æ¡ä»¶è§¦å‘äº† -> è°å…ˆå†™ï¼Œé‚£å°±å…ˆè§¦å‘è°ï¼

ğŸ’¡ï¼š`reaction`ä¸`autorun`çš„åŒºåˆ«ï¼Ÿ

- `autorun`ï¼šä¸æ”¹å˜æ•°æ®å°±è§¦å‘ä¸€æ¬¡`callback`
- `reaction`ï¼šä¸æ”¹å˜æ•°æ®å°±ä¸è§¦å‘

## â˜…action

> æƒ³è¦æ‰¹é‡æ“ä½œï¼Œè€Œä¸æ˜¯ä¸€ä¸ªçŠ¶æ€å˜åŒ–äº†ï¼Œå°±ä¼šè§¦å‘æ‰§è¡Œ`callback` -> å…¨éƒ¨æ”¹å®Œå†è§¦å‘ï¼

- å‰é¢çš„æ–¹å¼æ¯æ¬¡ä¿®æ”¹éƒ½ä¼šè§¦å‘`autorun`å’Œ`reaction`æ‰§è¡Œ
- ç”¨æˆ·ä¸€æ¬¡æ“ä½œéœ€è¦ä¿®æ”¹å¤šä¸ªå˜é‡ï¼Œä½†æ˜¯è§†å›¾æ›´æ–°åªéœ€è¦ä¸€æ¬¡
- ä»»ä½•åº”ç”¨éƒ½æœ‰åŠ¨ä½œï¼ŒåŠ¨ä½œæ˜¯ä»»ä½•ç”¨æ¥ä¿®æ”¹çŠ¶æ€çš„ä¸œè¥¿
- åŠ¨ä½œä¼šåˆ†æ‰¹å¤„ç†å˜åŒ–å¹¶åªåœ¨ï¼ˆæœ€å¤–å±‚çš„ï¼‰åŠ¨ä½œå®Œæˆåé€šçŸ¥è®¡ç®—å€¼å’Œååº”
- è¿™å°†ç¡®ä¿åœ¨åŠ¨ä½œå®Œæˆä¹‹å‰ï¼Œåœ¨åŠ¨ä½œæœŸé—´ç”Ÿæˆçš„ä¸­é—´å€¼æˆ–æœªå®Œæˆçš„å€¼å¯¹åº”ç”¨çš„å…¶ä½™éƒ¨åˆ†æ˜¯ä¸å¯è§çš„

### <mark>1ï¼‰action</mark>

``` js
import { action, autorun, computed, makeObservable, observable } from "mobx";

class Person {
  @observable area = "+86";
  @observable number = "12345678911";
  @computed get phone() {
    return this.area + "-" + this.number;
  }
  constructor() {
    makeObservable(this);
  }
  @action switchPhone(area, number) {
    this.area = area;
    this.number = number;
  }
}

let p1 = new Person();
autorun(() => {
  console.log(p1.phone);
});
p1.switchPhone("+1", "11122233366");

// é»˜è®¤æ‰§è¡Œï¼š+86-12345678911
// æ”¹äº†ä¸¤ä¸ªçŠ¶æ€æ‰æ‰§è¡Œä¸€æ¬¡ï¼š+1-11122233366
```

### <mark>2ï¼‰action.bound</mark>

å¦‚æœæˆ‘ä»¬æƒ³è¿™æ ·åšï¼š

``` js
let xxx = p1.switchPhone
xxx('+1',"11122233366")
```

é‚£ä¹ˆ`xxx`é‡Œè¾¹çš„`this`æ˜¾ç„¶ä¸æ˜¯`p1`å®ä¾‹äº†

æ‰€ä»¥æˆ‘ä»¬å°±æœ‰äº†`@action.bound` -> å®ƒå¸®æˆ‘ä»¬ç»‘å®šäº†`switchPhone`é‡Œè¾¹çš„`this`ä¸º`p1`å®ä¾‹

``` js
import { action, autorun, computed, makeObservable, observable } from "mobx";

class Person {
  @observable area = "+86";
  @observable number = "12345678911";
  @computed get phone() {
    return this.area + "-" + this.number;
  }
  constructor() {
    makeObservable(this);
  }
  @action.bound switchPhone(area, number) {
    this.area = area;
    this.number = number;
  }
}

let p1 = new Person();
autorun(() => {
  console.log(p1.phone);
});
// p1.switchPhone("+1", "11122233366");

let xxx = p1.switchPhone
xxx('+1',"11122233366")
```

> `@action.bound`æŠŠ`switchPhone`ææˆä¸º`switchPhone.bind(this)`äº†ï¼

### <mark>3ï¼‰runInAction</mark>

> ä¸ºå•¥éœ€è¦ï¼Ÿ -> éšæ„ç»„åˆå…¶å®ƒéœ€è¦è¢«ä¿®æ”¹çš„çŠ¶æ€ï¼Œè€Œä¸æ˜¯å½“ä½ éœ€è¦ä¿®æ”¹`phone`è¿™ä¸ªè®¡ç®—å±æ€§æ—¶ï¼Œéœ€è¦å®šä¹‰ä¸€ä¸ªç”¨`@action`ä¿®é¥°çš„`switchPhone`æ–¹æ³•ï¼Œç„¶åä¿®æ”¹`area`å’Œ`number`çŠ¶æ€ï¼

å®ƒåƒæ˜¯ä¸€ä¸ªäº‹åŠ¡ -> ç”¨æ¥æ‰¹å¤„ç†

ç¤ºä¾‹ï¼š

``` js
import { observable, runInAction } from "mobx"

const state = observable({ value: 0 })

runInAction(() => {
  state.value++
})
console.log(state.value) // 2
```

``` js
runInAction(()=>{
  p1.area = '+1';
  p1.number = '11122233366';
})
```

â¹ï¼š[å…³äº mobx runInAction çš„ä½¿ç”¨ - çŸ¥ä¹](https://zhuanlan.zhihu.com/p/77170757)

## â˜…mobx åº”ç”¨

* mobx-react æ ¸å¿ƒæ˜¯å°† `render` æ–¹æ³•åŒ…è£…ä¸º `autorun`
* è°ç”¨åˆ°äº†å¯è§‚å¯Ÿå±æ€§ï¼Œè°å°±éœ€è¦è¢« `observer` ä¿®é¥° -> æŒ‰éœ€æ¸²æŸ“

``` bash
yarn add react react-dom mobx-react
```

> mobox-react -> react ç»“åˆ mobx ä½¿ç”¨ï¼Œç±»ä¼¼ react-redux

### <mark>1ï¼‰è®¡æ•°å™¨</mark>

ç»„ä»¶ç›´æ¥è¯»ï¼š

``` jsx
import React, { Component } from "react";
import ReactDOM from "react-dom";
import { observable, action, makeObservable } from "mobx";
import { observer } from "mobx-react";

class Store {
  @observable number = 0;
  @action.bound add() {
    this.number++;
  }
  constructor() {
    makeObservable(this)
  }
}
let store = new Store();

// Counter ç±»ç»„ä»¶ç”¨åˆ°äº†å¯è§‚å¯Ÿå±æ€§ numberï¼Œæ‰€ä»¥éœ€è¦ç”¨ @observer ä¿®é¥°å®ƒ
// @observe å³èµ·åˆ°äº† autorun çš„ä½œç”¨ï¼Œç¬¬ä¸€æ¬¡é»˜è®¤æ¸²æŸ“ï¼Œä¹‹åæ ¹æ®ç»„ä»¶æ‰€ä¾èµ–çš„å¯è§‚å¯ŸçŠ¶æ€æ˜¯å¦å˜åŒ–æ¥æ¸²æŸ“
@observer
class Counter extends Component {
  render() {
    return (
      <div>
        <p>{store.number}</p>
        <button onClick={store.add}>+1</button>
      </div>
    );
  }
}
ReactDOM.render(<Counter />, document.querySelector("#root"));
```

![è®¡æ•°å™¨ç¤ºä¾‹](assets/img/2021-04-05-01-43-21.png)

å¦ä¸€ç§è·å–æ•°æ®çš„åšæ³•ï¼ˆä¼ è¿‡æ¥ï¼‰ï¼š

``` jsx
import React, { Component } from "react";
import ReactDOM from "react-dom";
import { observable, action, makeObservable } from "mobx";
import { observer } from "mobx-react";

class Store {
  @observable counter = { number: 0 };
  @action.bound add() {
    this.counter.number++;
  }
  constructor() {
    makeObservable(this)
  }
}
let store = new Store();
@observer
class Counter extends Component {
  // let store = this.props.store
  render() {
    return (
      <div>
        <p>{this.props.counter.number}</p>
        <button onClick={this.props.add}>+1</button>
      </div>
    );
  }
}
ReactDOM.render(
  <Counter counter={store.counter} add={store.add} />,
  document.querySelector("#root")
);
```

ğŸ’¡ï¼šå…³äº`@action.bound`çš„å®ç°ï¼Ÿ

ä¸æ˜¯é‚£ä¹ˆç®€å•çš„å®ç°ï¼Œæˆ‘æä¸æ˜ç™½çš„æ˜¯ï¼š

`action.bound`è¿™ä¸ªå‡½æ•°ï¼Œåœ¨æˆ‘ä»¬è¿˜æœª`new Store()`çš„æ—¶å€™ï¼Œå°±å·²ç»æ‰§è¡Œäº†ï¼Œå¯å®ƒæ˜¯å¦‚ä½•ç¡®å®š`add`é‡Œè¾¹çš„`this`æ˜¯æœªæ¥çš„å®ä¾‹`store`å‘¢ï¼Ÿ

å¦‚æœæˆ‘ä»¬ä¸åŠ `.bound`ï¼Œæˆ‘ä»¬æ˜¯ç›´æ¥è¿™æ ·äº†ï¼š

``` js
let store = new Store();
store.add = store.add.bind(store)
```

â¹ï¼š[autobind-decorator/index.js at master Â· andreypopp/autobind-decorator](https://github.com/andreypopp/autobind-decorator/blob/master/src/index.js)

### <mark>2ï¼‰TODO</mark>

``` jsx
import React, { Component, Fragment } from "react";
import ReactDOM from "react-dom";
import { observable, action, computed, makeObservable } from "mobx";
import PropTypes from "prop-types";
import { observer, PropTypes as ObservablePropTypes } from "mobx-react";
class Todo {
  id = Math.random();
  @observable text = "";
  @observable completed = false;
  constructor(text) {
    makeObservable(this)
    this.text = text;
  }
  @action.bound toggle() {
    this.completed = !this.completed;
  }
}
class Store {
  constructor() {
    makeObservable(this)
  }
  @observable todos = [];
  @computed get left() {
    return this.todos.filter((todo) => !todo.completed).length;
  }
  @computed get filterTodos() {
    return this.todos.filter((todo) => {
      switch (this.filter) {
        case "completed":
          return todo.completed;
        case "uncompleted":
          return !todo.completed;
        default:
          return true;
      }
    });
  }
  @observable filter = "all";
  @action.bound changeFilter(filter) {
    this.filter = filter;
    console.log(this.filter);
  }
  @action.bound addTodo(text) {
    this.todos.push(new Todo(text));
  }
  @action.bound removeTodo(todo) {
    this.todos.remove(todo);
  }
}
@observer
class TodoItem extends Component {
  static porpTypes = {
    todo: PropTypes.shape({
      id: PropTypes.number.isRequired,
      text: PropTypes.string.isRequired,
      completed: PropTypes.bool.isRequired,
    }).isRequired,
  };
  render() {
    let { todo } = this.props;
    return (
      <Fragment>
        <input
          type="checkbox"
          onChange={todo.toggle}
          checked={todo.completed}
        />
        <span className={todo.completed ? "completed" : ""}>{todo.text}</span>
      </Fragment>
    );
  }
}
@observer
class TodoList extends Component {
  static propsTypes = {
    store: PropTypes.shape({
      addTodo: PropTypes.func,
      todos: ObservablePropTypes.observableArrayOf(
        ObservablePropTypes.observableObject
      ),
    }).isRequired,
  };
  state = { text: "" };
  handleSubmit = (event) => {
    event.preventDefault();
    this.props.store.addTodo(this.state.text);
    this.setState({ text: "" });
  };
  handleChange = (event) => {
    this.setState({ text: event.target.value });
  };
  render() {
    let {
      filterTodos,
      left,
      removeTodo,
      filter,
      changeFilter,
    } = this.props.store;
    return (
      <div className="todo-list">
        <form onSubmit={this.handleSubmit}>
          <input
            placeholder="è¯·è¾“å…¥å¾…åŠäº‹é¡¹"
            type="text"
            value={this.state.text}
            onChange={this.handleChange}
          />
        </form>
        <ul>
          {filterTodos.map((todo) => (
            <li key={todo.id}>
              <TodoItem todo={todo} />
              <button onClick={() => removeTodo(todo)}>X</button>
            </li>
          ))}
        </ul>
        <p>
          <span>ä½ è¿˜æœ‰{left}ä»¶å¾…åŠäº‹é¡¹ï¼</span>
          <button
            onClick={() => changeFilter("all")}
            className={filter === "all" ? "active" : ""}
          >
            å…¨éƒ¨
          </button>
          <button
            onClick={() => changeFilter("uncompleted")}
            className={filter === "uncompleted" ? "active" : ""}
          >
            æœªå®Œæˆ
          </button>
          <button
            onClick={() => changeFilter("completed")}
            className={filter === "completed" ? "active" : ""}
          >
            å·²å®Œæˆ
          </button>
        </p>
      </div>
    );
  }
}
let store = new Store();
ReactDOM.render(<TodoList store={store} />, document.querySelector("#root"));
```

![æ•ˆæœ](assets/img/2021-04-05-17-29-20.png)

## â˜…ä¼˜åŒ–

### <mark>1ï¼‰observe</mark>

åªç›‘å¬æ•°ç»„å…ƒç´ çš„æ·»åŠ æˆ–åˆ é™¤ï¼š

``` js
import { observable, makeObservable, observe } from "mobx";

class Store {
  @observable todos = []
  constructor() {
    makeObservable(this)
    observe(this.todos,e=>{
      console.log(e)
    })
  }
}
let store = new Store()
store.todos.push('åƒé¥­é¥­')
store.todos.push('ç¡è§‰è§‰')
console.log(store)
console.log(store.todos) 
```

![ç›‘å¬ä¸€å±‚](assets/img/2021-04-05-14-56-16.png)

å½“æˆ‘è¿™æ ·åšæ—¶ï¼š

``` js
let store = new Store()
store.todos.push('åƒé¥­é¥­')
store.todos.push(['ç¡è§‰è§‰'])
store.todos.push({name:'frank',age:18})
// è§†é¢‘é‡Œéœ€è¦ store.todos.get(1) æ‰èƒ½æ‹¿åˆ°æ•°ç»„å…ƒç´ ï¼Œè€Œç°åœ¨æˆ‘ç”¨çš„è¿™ä¸ªæœ€æ–°ç‰ˆæ˜¯ä¸ç”¨çš„ï¼
console.log(store.todos[1])
store.todos[1].push('æ‰“è±†è±†')
console.log(store.todos[2].name)
```

![ä¸ä¼šè§¦å‘ cb æ‰§è¡Œ](assets/img/2021-04-05-15-05-37.png)

å¦‚æœæˆ‘ä»¬éå¾—è®©å®ƒå¯ä»¥è§¦å‘æ‰§è¡Œå‘¢ï¼Ÿé‚£ä¹ˆä½ å¾—è¿™æ ·åšï¼š

``` js
import { observable, makeObservable, observe } from "mobx";

class Store {
  @observable todos = [];
  // é‡Œè¾¹å­˜æ”¾ç€æ‰€æœ‰çš„å–æ¶ˆç›‘å¬çš„å‡½æ•°ï¼Œåªè¦è°ƒç”¨äº†ï¼Œç›‘å¬ç»“æŸï¼Œå³æ•°æ®å˜åŒ–äº†ï¼Œä¸ä¼šå†æ‰§è¡Œ cb äº†
  disposers = [];
  constructor() {
    makeObservable(this);
    observe(this.todos, (event) => {
      console.log(event);
      // è®©ä»¥å‰çš„æ‰€æœ‰ã€Œå–æ¶ˆç›‘å¬å‡½æ•°ã€æ‰§è¡Œ
      this.disposers.forEach((disposer) => disposer());
      this.disposers = [];
      for (let todo of event.object) {
        let disposer = observe(todo, (e) => {
          console.log(e);
        });
        this.disposers.push(disposer);
      }
    });
  }
}
let store = new Store();
// ä¸åŠ  observable ä¼šè¯´æ²¡æœ‰æƒé™ï¼Œå…¶å®ä¸€èˆ¬æ˜¯ä¸ç”¨åŠ æ‰å¯¹çš„ï¼
store.todos.push(observable("åƒé¥­é¥­"));
store.todos.push(["ç¡è§‰è§‰"]);
store.todos.push({ name: "frank", age: 18 });
// è§†é¢‘é‡Œéœ€è¦ store.todos.get(1) æ‰èƒ½æ‹¿åˆ°æ•°ç»„å…ƒç´ ï¼Œè€Œç°åœ¨æˆ‘ç”¨çš„è¿™ä¸ªæœ€æ–°ç‰ˆæ˜¯ä¸ç”¨çš„ï¼
console.log(store.todos[1]);
store.todos[1].push("æ‰“è±†è±†");
console.log(store.todos[2].name = 'Jack');
store.todos[0].set('åƒèœèœ')
console.log(store.todos)
```

### <mark>2ï¼‰spy</mark>

> é—´è°

è¿™ä¸ªè°ƒè¯•å¯èƒ½ä¼šç”¨ï¼Œä½†å¼€å‘å°±ä¸ä¼šç”¨äº†ï¼å› ä¸ºæ€§èƒ½å¾ˆå·® -> å®ƒä¼šç›‘å¬æ‰€æœ‰å˜åŒ–ï¼

``` js
import { observable, makeObservable, spy } from "mobx";
spy((e) => console.log(e));
class Store {
  @observable todos = [];
  constructor() {
    makeObservable(this);
  }
}
let store = new Store();
store.todos.push("åƒé¥­é¥­");
store.todos.push(["ç¡è§‰è§‰"]);
store.todos.push({ name: "frank", age: 18 });
// è§†é¢‘é‡Œéœ€è¦ store.todos.get(1) æ‰èƒ½æ‹¿åˆ°æ•°ç»„å…ƒç´ ï¼Œè€Œç°åœ¨æˆ‘ç”¨çš„è¿™ä¸ªæœ€æ–°ç‰ˆæ˜¯ä¸ç”¨çš„ï¼
// ä¸ºå•¥è¦è¿™æ ·ï¼Ÿå› ä¸ºè§†é¢‘é‡Œç”¨ push(observable({name:'xxx',age:18})) è¿™æ ·æ · push ä¸€ä¸ªæ•°æ®çš„
// è€Œè¿™ä¸ªå…ƒç´ æ˜¾ç„¶ä¸æ˜¯ä¸€ä¸ª æ™®é€šå¯¹è±¡ï¼Œè€Œæ˜¯ä¸€ä¸ªå¯è¢«è§‚å¯Ÿçš„æ™®é€šå¯¹è±¡
console.log(store.todos[1]);
store.todos[1].push("æ‰“è±†è±†");
console.log((store.todos[2].name = "Jack"));
store.todos[0] = "åƒèœèœ";
console.log(store.todos);
```

![spy](assets/img/2021-04-05-15-32-51.png)

### <mark>3ï¼‰toJS</mark>

> é€’å½’åœ°å°†ä¸€ä¸ª (observable) å¯¹è±¡è½¬æ¢ä¸º javascript ç»“æ„ã€‚ æ”¯æŒ observable æ•°ç»„ã€å¯¹è±¡ã€æ˜ å°„å’ŒåŸå§‹ç±»å‹ã€‚ è®¡ç®—å€¼å’Œå…¶å®ƒä¸å¯æšä¸¾çš„å±æ€§ä¸ä¼šæˆä¸ºç»“æœçš„ä¸€éƒ¨åˆ†ã€‚é»˜è®¤æƒ…å†µä¸‹å¯ä»¥æ­£ç¡®æ”¯æŒæ£€æµ‹åˆ°çš„å¾ªç¯ï¼Œä½†ä¹Ÿå¯ä»¥ç¦ç”¨å®ƒæ¥è·å¾—æ€§èƒ½ä¸Šçš„æå‡ã€‚

è¯­æ³•ï¼š`toJS(value, options?)`

ç¤ºä¾‹ 1ï¼š

``` js
import {
  observable,
  toJS,
  isObservableObject,
} from "mobx";
var obj = observable({
  x: 1,
});
console.log(obj);
var clone = toJS(obj);
console.log(clone);

console.log(isObservableObject(obj)); // true
console.log(isObservableObject(clone)); // false
```

![ç¤ºä¾‹ 1](assets/img/2021-04-05-17-51-28.png)

ç¤ºä¾‹ 2ï¼š

``` js
import {
  observable,
  toJS,
  isObservableObject,
  makeObservable,
  observe,
} from "mobx";

class ToDo {
  @observable todos = [];
  disposers = [];
  constructor() {
    makeObservable(this);
    observe(this.todos, (change) => {
      console.log(change);
      this.disposers.forEach((disposer) => disposer());
      this.disposers = [];
      for (let todo of change.object) {
        this.disposers.push(
          observe(todo, (change) => {
            this.save();
            //console.log(change)
          })
        );
      }
      this.save();
    });
  }
  save() {
    console.log(this.todos)
    localStorage.setItem("todos", JSON.stringify(toJS(this.todos)));
  }
}

let todoList = new ToDo();
todoList.todos.push(observable("åƒé¥­"));
todoList.todos.push({ name: "frank", age: 18 });
```

![ç¤ºä¾‹ 2](assets/img/2021-04-05-17-52-08.png)

### <mark>4ï¼‰trace</mark>

`trace` æ˜¯ä¸€ä¸ªå°å·¥å…·ï¼Œå®ƒèƒ½å¸®åŠ©ä½ æŸ¥æ‰¾ä¸ºä»€ä¹ˆè®¡ç®—å€¼ã€ reactions æˆ–ç»„ä»¶ä¼šé‡æ–°è®¡ç®—

### <mark>5ï¼‰ç¤ºä¾‹</mark>

* æŠŠè§†å›¾æ‹†è§£çš„æ›´ç»†è‡´
* ä½¿ç”¨ä¸“é—¨çš„è§†å›¾æ¸²æŸ“åˆ—è¡¨æ•°æ®
* å°½å¯èƒ½æ™šçš„è§£æ„ä½¿ç”¨æ•°æ®

``` jsx
import React, { Component, Fragment } from "react";
import ReactDOM from "react-dom";
import {
  trace,
  observable,
  action,
  computed,
  observe,
  spy,
  toJS,
  makeObservable,
} from "mobx";
import PropTypes from "prop-types";
import { observer, PropTypes as ObservablePropTypes } from "mobx-react";
spy((event) => {
  //console.log(event);
});
class Todo {
  id = Math.random();
  @observable text = "";
  @observable completed = false;
  constructor(text) {
    makeObservable(this);
    this.text = text;
  }
  @action.bound toggle() {
    this.completed = !this.completed;
  }
}
class Store {
  disposers = [];
  constructor() {
    makeObservable(this);
    observe(this.todos, (change) => {
      console.log(change);

      this.disposers.forEach((disposer) => disposer());
      this.disposers = [];
      for (let todo of change.object) {
        this.disposers.push(
          observe(todo, (change) => {
            this.save();
            //console.log(change)
          })
        );
      }
      this.save();
    });
  }
  save() {
    localStorage.setItem("todos", JSON.stringify(toJS(this.todos)));
  }
  @observable todos = [];
  @computed get left() {
    return this.todos.filter((todo) => !todo.completed).length;
  }
  @computed get filterTodos() {
    return this.todos.filter((todo) => {
      switch (this.filter) {
        case "completed":
          return todo.completed;
        case "uncompleted":
          return !todo.completed;
        default:
          return true;
      }
    });
  }
  @observable filter = "all";
  @action.bound changeFilter(filter) {
    console.log("hi");
    this.filter = filter;
    console.log(this.filter);
  }
  @action.bound addTodo(text) {
    this.todos.push(new Todo(text));
  }
  @action.bound removeTodo(todo) {
    this.todos.remove(todo);
  }
}
@observer
class TodoItem extends Component {
  static propTypes = {
    todo: PropTypes.shape({
      id: PropTypes.number.isRequired,
      text: PropTypes.string.isRequired,
      completed: PropTypes.bool.isRequired,
    }).isRequired,
  };
  render() {
    trace();
    let { todo } = this.props;
    return (
      <Fragment>
        <input
          type="checkbox"
          onChange={todo.toggle}
          checked={todo.completed}
        />
        <span className={todo.completed ? "completed" : ""}>{todo.text}</span>
      </Fragment>
    );
  }
}
@observer
class TodoFooter extends Component {
  static propTypes = {};
  render() {
    trace();
    let { left, filter, changeFilter } = this.props.store;
    return (
      <div>
        <span>ä½ è¿˜æœ‰{left}ä»¶å¾…åŠäº‹é¡¹ï¼</span>
        <button
          onClick={() => changeFilter("all")}
          className={filter === "all" ? "active" : ""}
        >
          å…¨éƒ¨
        </button>
        <button
          onClick={() => changeFilter("uncompleted")}
          className={filter === "uncompleted" ? "active" : ""}
        >
          æœªå®Œæˆ
        </button>
        <button
          onClick={() => changeFilter("completed")}
          className={filter === "completed" ? "active" : ""}
        >
          å·²å®Œæˆ
        </button>
      </div>
    );
  }
}
@observer
class TodoViews extends Component {
  render() {
    let { filterTodos, removeTodo } = this.props.store;
    return (
      <ul>
        {filterTodos.map((todo) => (
          <li key={todo.id}>
            <TodoItem todo={todo} />
            <button onClick={() => removeTodo(todo)}>X</button>
          </li>
        ))}
      </ul>
    );
  }
}
@observer
class TodoHeader extends Component {
  state = { text: "" };
  handleSubmit = (event) => {
    event.preventDefault();
    this.props.store.addTodo(this.state.text);
    this.setState({ text: "" });
  };
  handleChange = (event) => {
    this.setState({ text: event.target.value });
  };
  render() {
    return (
      <form onSubmit={this.handleSubmit}>
        <input
          placeholder="è¯·è¾“å…¥å¾…åŠäº‹é¡¹"
          type="text"
          value={this.state.text}
          onChange={this.handleChange}
        />
      </form>
    );
  }
}
@observer
class TodoList extends Component {
  static propsTypes = {
    store: PropTypes.shape({
      addTodo: PropTypes.func,
      todos: ObservablePropTypes.observableArrayOf(
        ObservablePropTypes.observableObject
      ),
    }).isRequired,
  };

  render() {
    trace();
    return (
      <div className="todo-list">
        <TodoHeader store={this.props.store} />
        <TodoViews store={this.props.store} />
        <TodoFooter store={this.props.store} />
      </div>
    );
  }
}
let store = new Store();
ReactDOM.render(<TodoList store={store} />, document.querySelector("#root"));
```

![ä¼˜åŒ–åçš„æ•ˆæœ](assets/img/2021-04-05-18-41-52.png)

> æµ‹è¯•ï¼šè¯»æœ¬åœ°æ•°æ® -> èµ‹å€¼ç»™`todos` -> æ¸²æŸ“ -> ä¼šæœ‰ bugï¼
