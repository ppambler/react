### âœï¸ Tangxt â³ 2021-02-04 ğŸ·ï¸ Context API

# 06-React Context API

## â˜…è¯¾ä»¶

é¢„ä¹ å†…å®¹ï¼š<https://reactjs.org/docs/context.html>
ä¸­æ–‡ç¿»è¯‘ï¼š<https://react.docschina.org/docs/context.html#when-to-use-context>

* [JS demo](https://codesandbox.io/s/yj7ox1lrz9)
* [React demo](https://codesandbox.io/s/m7pojr19xj)
* [consumer demo](https://codesandbox.io/s/99wym030y)
* [æ¢è‚¤ demo](https://codesandbox.io/s/8rvz0qpj8)

![Context API](assets/img/2021-02-04-10-28-44.png)

> æ­¤å›¾æ¥æºï¼š[æ€æ ·ä½¿ç”¨ React Context API - SegmentFault æ€å¦](https://segmentfault.com/a/1190000018215032)

## â˜…å››å±‚å‡½æ•°ä¼ é€’å€¼

Context æ˜¯ React çš„ APIï¼ŒAPI æ˜¯ä»€ä¹ˆï¼Ÿä¸ç”¨ç®¡å®ƒæ˜¯ä»€ä¹ˆï¼Œä½ ç›´æ¥ç”¨å³å¯ -> API ï¼Œç¨‹åºå‘˜ç»å¸¸è¯´ï¼Œä½†æ˜¯å°±æ˜¯æ²¡æœ‰äººèƒ½æ¸…æ¥šåœ°è§£é‡Šå®ƒæ˜¯ä»€ä¹ˆï¼Œå½“ç„¶ï¼Œä½ å¯ä»¥ç®€å•æŠŠå®ƒç†è§£ä¸ºã€Œåˆ«äººæä¾›ç»™ä½ ç”¨çš„ä¸œè¥¿å°±å« APIã€

Context è¿™ä¸ª APIï¼Œè§£é‡Šèµ·æ¥ç›¸å½“å¤æ‚ -> æ–¹æ–¹ä¼šä»æ€æƒ³ä¸Šç»™å¤§å®¶è§£æƒ‘

ä¹‹å‰å­¦ä¹ äº†ã€Œå¦‚ä½•åšç»„ä»¶é—´çš„é€šä¿¡ï¼Ÿã€ -> ä¸ä»Šå¤©æ‰€è®²çš„è¿™ä¸ª Context API æœ‰éå¸¸å¤§çš„è”ç³»ï¼

è¯åˆè¯´å›æ¥ï¼Œä¸Šä¸€èŠ‚ç•™äº†ä¸€ä¸ªæ‚¬å¿µï¼šreact-redux æ˜¯å¦‚ä½•å®ç°ä¸€ä¸ªæ ‡ç­¾å°±èƒ½è®©æ‰€æœ‰çš„å…ƒç´ éƒ½æ‹¥æœ‰ä¸€ä¸ªæ–¹æ³•å‘¢ï¼Ÿ

1ï¼‰åœ¨ä¸€ä¸ªå‡½æ•°é‡Œè¾¹è°ƒä¸€ä¸ªå‡½æ•°ï¼ˆä¸€å…±å››å±‚ï¼‰

ğŸ’¡ï¼šéœ€æ±‚ 1ï¼šæŠŠä¸€ä¸ªå˜é‡ä¼ ç»™ `f4`

![ä¼ å˜é‡](assets/img/2021-02-05-09-54-10.png)

å®ç°ï¼š

![ä¼ å˜é‡](assets/img/2021-02-05-10-09-10.png)

æˆ‘ä»¬ä¸èƒ½åœ¨ `f4` é‡Œè¾¹ç›´æ¥è®¿é—® `let n` è¿™ä¸ª `n` å˜é‡ -> å› ä¸ºå®ƒæ˜¯åœ¨å—çº§ä½œç”¨åŸŸ `{}` é‡Œè¾¹çš„å˜é‡ï¼

ä¸‹ä¸€æ­¥ -> ä½¿ç”¨ React å˜å½¢è¿™ä¸ªè¿‡ç¨‹

2ï¼‰ä½¿ç”¨ React

> åœ¨å†™ JSX ä»£ç çš„æ—¶å€™ï¼Œè¯·å‘Šè¯‰è‡ªå·±æˆ‘å¹¶ä¸æ˜¯åœ¨å†™ HTMLï¼Œä¸ç„¶ï¼Œä½ å°±æ˜¯å®Œå…¨ä¸æ‡‚ React -> æ€»ä¹‹ï¼Œç»å¸¸ä½¿ç”¨é‚£ä¸ª <babeljs.io> å·¥å…·

![ä¸€å±‚ä¸€å±‚åœ°ä¼  props](assets/img/2021-02-05-11-05-12.png)

æˆ‘ä»¬ç”¨ React çš„å½¢å¼æŠŠä¹‹å‰é‚£ä¸ª f1~f4 çš„è°ƒç”¨ç»™æ¼”ç¤ºäº†ä¸€éï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬å†™æ ‡ç­¾å®é™…ä¸Šè¿˜æ˜¯åœ¨è°ƒç”¨å‡½æ•°ï¼ï¼ˆä¸æ˜¯é©¬ä¸Šè°ƒç”¨ï¼ŒAPI å†…éƒ¨ä¼šè°ƒç”¨å®ƒï¼‰

![è°ƒç”¨å‡½æ•°](assets/img/2021-02-05-11-11-01.png)

é—®é¢˜ï¼šä¸€å±‚å±‚åœ°ä¼  props å¤ªéº»çƒ¦äº†ï¼Œå¦‚æœæˆ‘ä»¬åªæƒ³ `F4` ç»„ä»¶æ‹¿åˆ° `n` ï¼Œå…¶å®ƒ `F1~F3` ä¸éœ€è¦ï¼Œé‚£ä¹ˆæˆ‘ä»¬èƒ½å¦æŠŠä¸€å±‚ä¸€å±‚è¿™æ ·ä¼ çš„è¿‡ç¨‹ç»™çœç•¥æ‰å‘¢ï¼Ÿ

å›å¤´çœ‹é‚£ä¸ªåŸç”Ÿ JS ä»£ç ï¼Œç­”æ¡ˆæ˜¯ä¸è¡Œçš„ï¼Œå› ä¸ºç”¨ `let` å£°æ˜çš„å˜é‡ `n` åœ¨ `{}` é‡Œè¾¹å•Šï¼ `f4` å‡½æ•°åªèƒ½ä» `f3` é‚£é‡Œæ‹¿åˆ° `n` â€¦â€¦

é—®é¢˜æ¥äº†ï¼šä¸ºå•¥ä¸æŠŠå†™åœ¨ `{}` é‡Œè¾¹çš„ `n` æåˆ° `{}` å¤–è¾¹å»å‘¢ï¼Ÿ

ğŸ’¡ï¼šå†™çš„ React ç»„ä»¶æ ‡ç­¾ï¼Œå¿…é¡»æ˜¯å¤§å†™å­—æ¯å¼€å¤´

![å¤§å†™å¼€å¤´](assets/img/2021-02-05-10-56-38.png)

## â˜…ç”¨ Context API ä¼ å€¼

1ï¼‰å…¨å±€å˜é‡æ…ç”¨

![å…¨å±€å˜é‡](assets/img/2021-02-05-11-52-36.png)

å¦‚æœç”¨äº†å…¨å±€å˜é‡ï¼Œé‚£ä¹ˆç»“æœå¾ˆæœ‰å¯èƒ½ä¸æ˜¯ä½ æƒ³è¦çš„å€¼ï¼

æ¯”å¦‚ï¼š

``` js
let n = 100;

function f1() {
  console.log(1);
  f2();
}

function f2() {
  console.log(2);
  f3();
}

n = 50

function f3() {
  console.log(3);
  f4();
}

function f4() {
  console.log(4, n);
}

{
  setTimeout(() => {
    f1();
  })
  console.log("done");
}

n = 66
```

æˆ‘ä»¬å¿…é¡»æŠŠä»£ç çœ‹å®Œï¼Œæ‰èƒ½ç¡®å®š`n`çš„å€¼æ˜¯`66`ï¼Œè€Œä¸æ˜¯`f4`ä¸€æ‰§è¡Œå°±åªçœ‹ä¸Šè¾¹çš„ä»£ç â€¦â€¦

æ€»ä¹‹ï¼Œå…¨å±€å˜é‡çš„`n`ä½œç”¨èŒƒå›´å¤ªå¹¿äº†â€¦â€¦

é—®é¢˜æ¥äº†ï¼šå¦‚ä½•è®©`f4`æ‹¿åˆ°`n`çš„å€¼ï¼Œè€Œä¸”åˆä¸ä¼šå› ä¸ºå…¶å®ƒå› ç´ å½±å“åˆ°`n`çš„å€¼å‘¢ï¼Ÿ

æˆ‘ä»¬å¯ä»¥åšä¸€ä¸ªçº¦å®š -> ä¼ ä¸€ä¸ªå±€éƒ¨çš„å…¨å±€å˜é‡ï¼Œè¿™ä¸ªå˜é‡å¤§å®¶éƒ½èƒ½è®¿é—®ï¼Œä½†æ˜¯å°±ä¸ç»™åˆ«äººè®¿é—® -> ä¸æ˜¯ä¸€å®¶äººä¸è¿›ä¸€å®¶é—¨

2ï¼‰å¦‚ä½•åšä¸€ä¸ªå±€éƒ¨çš„å…¨å±€å˜é‡ï¼Ÿ

- ES5ï¼šç«‹å³æ‰§è¡Œå‡½æ•°é€ å±€éƒ¨çš„å…¨å±€å˜é‡
- ES6ï¼šç›´æ¥`{}`ï¼Œä½†è¦ç”¨`let/const`å£°æ˜çš„å˜é‡

``` js
{
  let x = {}
  // è®¿é—®å™¨
  window.setX = (key,value)=>{
    x[key] = value
  }
}
{
  window.setX('n',100)
}
```

`x`å°±æ˜¯å±€éƒ¨çš„å…¨å±€å˜é‡ï¼Œè¡¨ç¤ºåªåœ¨å®ƒè‡ªå·±é‚£å—ä½œç”¨åŸŸé‡Œè¾¹æœ‰ç”¨ï¼Œä½†åœ¨å…¶å®ƒåœ°æ–¹å°±ä¸èƒ½ç”¨äº†ï¼

> è‡ªå·±é‚£å—åŒºåŸŸèƒ½ç”¨ï¼Œçœ‹èµ·æ¥è‡ªå·±æ˜¯å…¨å±€å˜é‡ï¼Œä½†åœ¨å®ƒçš„ä¸Šä¸€çº§`window`çœ‹æ¥ï¼Œå®ƒå°±æ˜¯å±€éƒ¨å˜é‡äº†ï¼

``` js
{
  let context = {};
  window.setContext = (key, value) => {
    context[key] = value;
  };

  window.f1 = function () {
    console.log(1);
    f2();
  };
  function f2() {
    console.log(2);
    f3();
  }

  function f3() {
    console.log(3);
    f4();
  }
  function f4() {
    console.log(4, context["n"]);
  }
}

{
  window.setContext("n", 100);
  setTimeout(() => {
    f1();
  });
  console.log("done");
}

```

å›è¿‡å¤´æ¥ä¸Šè¾¹çš„ä»£ç æ˜¯å¦è¾¾åˆ°äº†æˆ‘ä»¬çš„éœ€æ±‚ï¼š

- `f1~f3`ä¸éœ€è¦ç”¨åˆ°`n`ï¼Œåªæœ‰`f4`ç”¨åˆ°äº†`n`
- `context`å¯ä»¥éšæ„æ”¹åŠ¨å—ï¼Ÿä¸èƒ½ï¼Œä½ å¾—é€šè¿‡`window.setX`æ‰èƒ½æ”¹åŠ¨ -> æˆ‘ä»¬æŠŠå®ƒé™åˆ¶åˆ°åªèƒ½åœ¨æŸä¸ªä½œç”¨åŸŸä¸‹èµ·ä½œç”¨ï¼Œæ›´è¿›ä¸€æ­¥æ¥æï¼Œåƒ`f1~f4`ä¹Ÿä¸èƒ½ç›´æ¥è®¿é—®å®ƒâ€¦â€¦

æ¥ä¸‹æ¥ï¼Œçœ‹çœ‹ React å½¢å¼æ€æ ·çš„

3ï¼‰Context API

æ–‡æ¡£ï¼š<https://zh-hans.reactjs.org/docs/context.html>

![Context API](assets/img/2021-02-05-17-28-06.png)

æ€»ä¹‹ï¼Œè¯¥ API å°±æ˜¯ä¸ºäº†è§£å†³ã€Œprop drillingã€è¿™ä¸ªé—®é¢˜çš„ï¼

![prop drilling](assets/img/2021-02-05-17-31-38.png)

ä¹‹å‰æˆ‘ä»¬æ˜¯é€šè¿‡ç®¡å®¶ã€EventHub æ¥ç®¡ç†æ•°æ®çš„ï¼Œè€Œç°åœ¨æˆ‘ä»¬åˆ™é€šè¿‡ Contextï¼ˆå±€éƒ¨çš„å…¨å±€å˜é‡ï¼‰æ¥ç®¡ç†æ•°æ®ï¼

---

ğŸ’¡ï¼šä½•æ—¶ä½¿ç”¨ Contextï¼Ÿ

> Context è®¾è®¡ç›®çš„æ˜¯ä¸ºäº†å…±äº«é‚£äº›å¯¹äºä¸€ä¸ªç»„ä»¶æ ‘è€Œè¨€æ˜¯â€œå…¨å±€â€çš„æ•°æ®

è¿™å¥è¯çš„è¨€å¤–ä¹‹æ„å°±æ˜¯ã€Œå±€éƒ¨çš„å…¨å±€å˜é‡ã€

> å…³äºå®˜æ–¹æ–‡æ¡£ï¼Œå³ä¾¿æ˜¯è‹±æ–‡å¥½çš„çœ‹è‹±æ–‡æ–‡æ¡£ä¹Ÿä¸ä¸€å®šèƒ½ææ‡‚ï¼Œæ›´ä¸ç”¨è¯´ä¸­æ–‡æ–‡æ¡£äº†â€¦â€¦

``` jsx
class App extends React.Component {
  render() {
    return <Toolbar theme="dark" />;
  }
}

function Toolbar(props) {
  // Toolbar ç»„ä»¶æ¥å—ä¸€ä¸ªé¢å¤–çš„â€œthemeâ€å±æ€§ï¼Œç„¶åä¼ é€’ç»™ ThemedButton ç»„ä»¶ã€‚
  // å¦‚æœåº”ç”¨ä¸­æ¯ä¸€ä¸ªå•ç‹¬çš„æŒ‰é’®éƒ½éœ€è¦çŸ¥é“ theme çš„å€¼ï¼Œè¿™ä¼šæ˜¯ä»¶å¾ˆéº»çƒ¦çš„äº‹ï¼Œ
  // å› ä¸ºå¿…é¡»å°†è¿™ä¸ªå€¼å±‚å±‚ä¼ é€’æ‰€æœ‰ç»„ä»¶ã€‚
  return (
    <div>
      <ThemedButton theme={props.theme} />
    </div>
  );
}

class ThemedButton extends React.Component {
  render() {
    return <Button theme={this.props.theme} />;
  }
}

function Button(props) {
  return <button>{props.theme}</button>
}
```

å¦‚ä½•çœ‹å¾…è¿™ä¸ªä¾‹å­ï¼Ÿ -> `Toolbarã€ThemedButtonã€Button`å°±æ˜¯`F1~F3`

ä½¿ç”¨ `context`, æˆ‘ä»¬å¯ä»¥é¿å…é€šè¿‡ä¸­é—´å…ƒç´ ä¼ é€’ `props`ï¼š

``` jsx
// Context å¯ä»¥è®©æˆ‘ä»¬æ— é¡»æ˜ç¡®åœ°ä¼ éæ¯ä¸€ä¸ªç»„ä»¶ï¼Œå°±èƒ½å°†å€¼æ·±å…¥ä¼ é€’è¿›ç»„ä»¶æ ‘ã€‚
// ä¸ºå½“å‰çš„ theme åˆ›å»ºä¸€ä¸ª contextï¼ˆâ€œlightâ€ä¸ºé»˜è®¤å€¼ï¼‰ã€‚
const ThemeContext = React.createContext("light");
class App extends React.Component {
  render() {
    // ä½¿ç”¨ä¸€ä¸ª Provider æ¥å°†å½“å‰çš„ theme ä¼ é€’ç»™ä»¥ä¸‹çš„ç»„ä»¶æ ‘ã€‚
    // æ— è®ºå¤šæ·±ï¼Œä»»ä½•ç»„ä»¶éƒ½èƒ½è¯»å–è¿™ä¸ªå€¼ã€‚
    // åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°† â€œdarkâ€ ä½œä¸ºå½“å‰çš„å€¼ä¼ é€’ä¸‹å»ã€‚
    return (
      <ThemeContext.Provider value="dark">
        <Toolbar />
      </ThemeContext.Provider>
    );
  }
}

// ä¸­é—´çš„ç»„ä»¶å†ä¹Ÿä¸å¿…æŒ‡æ˜å¾€ä¸‹ä¼ é€’ theme äº†ã€‚
function Toolbar() {
  return (
    <div>
      <ThemedButton />
    </div>
  );
}

class ThemedButton extends React.Component {
  // æŒ‡å®š contextType è¯»å–å½“å‰çš„ theme contextã€‚
  // React ä¼šå¾€ä¸Šæ‰¾åˆ°æœ€è¿‘çš„ theme Providerï¼Œç„¶åä½¿ç”¨å®ƒçš„å€¼ã€‚
  // åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå½“å‰çš„ theme å€¼ä¸º â€œdarkâ€ã€‚
  static contextType = ThemeContext;
  render() {
    return <Button theme={this.context} />;
  }
}

function Button(props) {
  return <button>{props.theme}</button>;
}
```

å¯¹æ¯”ä¹‹å‰çš„ä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼š

- F1ï¼šå¤šäº†`<ThemeContext.Provider value="dark"></ThemeContext.Provider>`
- F2ï¼šå¤šäº†`static contextType = ThemeContext;`ã€`this.context`

è§†é¢‘æ•™ç¨‹é‡Œè¾¹çš„ä»£ç ï¼ˆreact 16.5.2ï¼‰ï¼š

![ç¤ºä¾‹](assets/img/2021-02-05-18-15-50.png)

å¯ä»¥çœ‹åˆ°ä¸ç°åœ¨çš„ react 17.0.1 æ˜¯æœ‰åŒºåˆ«çš„â€¦â€¦

é—®é¢˜æ¥äº†ï¼šContext API æ˜¯å¦‚ä½•åšåˆ°çš„å‘¢ï¼Ÿ

æ¥ä¸‹æ¥ï¼Œå°±æŠŠæˆ‘ä»¬ä¹‹å‰é‚£ä¸ªæŠ½è±¡ä¸€ç‚¹çš„`F1~F4`ä»£ç æ”¹æˆæ˜¯ç”¨ Context API çš„

å›é¡¾éœ€æ±‚ï¼š

- åªæœ‰ F4 ç»„ä»¶éœ€è¦æ•°æ®
- è€Œä¸”ä¸éœ€è¦å±‚å±‚ä¼ é€’æ•°æ®åˆ° F4

4ï¼‰å¦‚ä½•ä½¿ç”¨ Context API æ”¹å†™ä¾‹å­

> ä¾è‘«èŠ¦ç”»ç“¢â€¦â€¦

![nContext](assets/img/2021-02-05-18-51-00.png)

è§£é‡Šè¿™ä¸ª`nContext.Consumer`

![nContext.Consumer](assets/img/2021-02-05-20-02-43.png)

`Consumer`ç»„ä»¶çš„å®ç°å…¶å®æ˜¯è¿™æ ·çš„ï¼š

![Consumer](assets/img/2021-02-05-20-26-32.png)


