### âœï¸ Tangxt â³ 2021-04-09 ğŸ·ï¸ epic

# 03-epic é¡¹ç›®æ–‡ä»¶ä¸Šä¼ ã€ä¸Šä¼ å†å²

![å®ç°çš„æ•ˆæœ](assets/img/2021-04-09-13-04-43.png)

1ï¼‰leancloud å®ç°æ–‡ä»¶ä¸Šä¼ ã€å›¾ç‰‡ä¿¡æ¯å…¨å±€çŠ¶æ€ç®¡ç†

> æ–‡æ¡£ï¼š[æ•°æ®ç±»å‹](https://leancloud.cn/docs/leanstorage_guide-js.html#hash799084270)ã€[æ–‡ä»¶](https://leancloud.cn/docs/leanstorage_guide-js.html#hash825935)

![API](assets/img/2021-04-09-16-37-58.png)

> model -> æ¥å£å±‚ã€æ¨¡å‹å±‚ï¼›store -> å…¨å±€çŠ¶æ€ï¼›components -> UI å±‚

1ã€ä¸æœåŠ¡å™¨æ‰“äº¤é“çš„ Uploader

``` js
const Uploader = {
  add(file, filename) {
    const item = new AV.Object("Image");
    const avFile = new AV.File(filename, file);
    item.set("filename", filename);
    item.set("owner", AV.User.current());
    item.set("url", avFile);
    return new Promise((resolve, reject) => {
      item.save().then(
        (serverFile) => resolve(serverFile),
        (error) => reject(error)
      );
    });
  },
};
```

ğŸ’¡ï¼š`new AV.Object("Image")`ï¼Ÿ

> åœ¨æ„å»ºå¯¹è±¡æ—¶ï¼Œä¸ºäº†ä½¿äº‘ç«¯çŸ¥é“å¯¹è±¡å±äºå“ªä¸ª classï¼Œéœ€è¦å°† class çš„åå­—ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚ä½ å¯ä»¥å°† LeanCloud é‡Œé¢çš„ class æ¯”ä½œå…³ç³»å‹æ•°æ®åº“é‡Œé¢çš„è¡¨ã€‚ä¸€ä¸ª class çš„åå­—å¿…é¡»ä»¥å­—æ¯å¼€å¤´ï¼Œä¸”åªèƒ½åŒ…å«æ•°å­—ã€å­—æ¯å’Œä¸‹åˆ’çº¿ã€‚

æ‰€ä»¥åˆ›å»ºäº†ä¸€å¼ è¡¨ï¼š

![åˆ›å»ºä¸€å¼ è¡¨](assets/img/2021-04-09-16-44-14.png)

ğŸ’¡ï¼š`new AV.File(filename, file)`ï¼Ÿ

> æœ‰æ—¶å€™åº”ç”¨éœ€è¦å­˜å‚¨å°ºå¯¸è¾ƒå¤§æˆ–ç»“æ„è¾ƒä¸ºå¤æ‚çš„æ•°æ®ï¼Œè¿™ç±»æ•°æ®ä¸é€‚åˆç”¨ `AV.Object` ä¿å­˜ï¼Œæ­¤æ—¶æ–‡ä»¶å¯¹è±¡ `AV.File` ä¾¿æˆä¸ºäº†æ›´å¥½çš„é€‰æ‹©ã€‚æ–‡ä»¶å¯¹è±¡æœ€å¸¸è§çš„ç”¨é€”æ˜¯**ä¿å­˜å›¾ç‰‡**ï¼Œä¸è¿‡ä¹Ÿå¯ä»¥ç”¨æ¥ä¿å­˜æ–‡æ¡£ã€è§†é¢‘ã€éŸ³ä¹ç­‰å…¶ä»–äºŒè¿›åˆ¶æ•°æ®ã€‚

ç¤ºä¾‹ï¼š

``` js
const data = { base64: 'TGVhbkNsb3Vk' };
// resume.txt æ˜¯æ–‡ä»¶å
const file = new AV.File('resume.txt', data);
```

ğŸ’¡ï¼š`item`é…åˆ`avFile`ä½¿ç”¨ï¼Ÿ

`AV.Object`æ——ä¸‹çš„å±æ€§æ”¯æŒä¸¤ç§ç‰¹æ®Šçš„æ•°æ®ç±»å‹ `Pointer` å’Œ `File`ï¼Œå¯ä»¥åˆ†åˆ«ç”¨æ¥å­˜å‚¨æŒ‡å‘å…¶ä»– `AV.Object` çš„æŒ‡é’ˆä»¥åŠäºŒè¿›åˆ¶æ•°æ®

æ‰€ä»¥ï¼š

ä½ ä¸Šä¼ äº†ä¸€å¼ å›¾ç‰‡ï¼Œå°±æ˜¯åœ¨`Image`è¡¨é‡Œåˆ›å»ºä¸€æ¡è®°å½•ï¼š

![è®°å½•](assets/img/2021-04-09-16-54-10.png)

æ­¤åˆ»ï¼Œ`Image`è¡¨é‡Œçš„è¿™ä¸ª`item`è®°å½•çš„è¿™ä¸ª`url`å­—æ®µæŒ‡å‘äº†`File`è¡¨é‡Œ`avFile`è¿™æ¡è®°å½•

![è¡¨ä¸è¡¨ä¹‹é—´çš„å…³è”](assets/img/2021-04-09-17-01-47.png)

> å­˜å‚¨æœåŠ¡ä¼¼ä¹ç”¨äº†ä¸ƒç‰›æä¾›çš„å­˜å‚¨æœåŠ¡ï¼

ğŸ’¡ï¼š`item.save()`ï¼Ÿ

æ˜¯ä¸ªå¼‚æ­¥æ“ä½œï¼ŒæŠŠæ•°æ®å­˜å‚¨åˆ°è¿œç¨‹æ•°æ®åº“ï¼Œå¦‚æœå­˜å‚¨æˆåŠŸï¼Œå“åº”å›æ¥ç»™æˆ‘ä»¬çš„`serverFile`æ˜¯è¿™æ ·ä¸€ä¸ªä¸œè¥¿ï¼š

![serverFile](assets/img/2021-04-09-17-10-26.png)

2ã€å…¨å±€çŠ¶æ€ ImageStore

``` js
import { observable, action, makeObservable } from "mobx";
import { Uploader } from "../models";

class ImageStore {
  constructor() {
    makeObservable(this);
  }
  @observable filename = "";
  @observable file = null;
  @observable serverFile = null;
  @observable isUploading = false;
  @action setFilename(newFilename) {
    this.filename = newFilename;
  }
  @action setFile(newFile) {
    this.file = newFile;
  }
  @action upload() {
    this.isUploading = true;
    return new Promise((resolve, reject) => {
      Uploader.add(this.file, this.filename)
        .then((serverFile) => {
          this.serverFile = serverFile;
          resolve(serverFile);
        })
        .catch((err) => {
          console.error("ä¸Šä¼ å¤±è´¥");
          reject(err);
        })
        .finally(() => (this.isUploading = false));
    });
  }
}

export default new ImageStore();
```

`Uploader`ç»„ä»¶ä½¿ç”¨å…¨å±€æ•°æ®ï¼š

![ä¸Šä¼ ç»„ä»¶](assets/img/2021-04-09-19-42-45.png)

> è¿™è·Ÿä¹‹å‰çš„ç™»å½•æ³¨å†ŒåŠŸèƒ½æ˜¯ä¸€æ ·çš„å†™ä»£ç å§¿åŠ¿ï¼ -> `Store`ç»´æŠ¤äº†æˆ‘ä»¬è¦ä¼ ç»™åå°çš„å‚æ•°

æ•ˆæœï¼š

![æ•ˆæœ](assets/img/2021-04-09-19-46-26.png)

ğŸ’¡ï¼šä¸ºä»€ä¹ˆæŠ½ç¦»å‡ºä¸€ä¸ª Uploader ç»„ä»¶ï¼Ÿ

è¿™ä¸ªç»„ä»¶æ˜¯ç»™ Home é¡µé¢ç”¨çš„ï¼è€Œè¿™ä¸ªé¡µé¢éœ€è¦ç”¨åˆ°å¾ˆå¤šä¸œè¥¿ï¼Œå¦‚æœä¸æŠŠä¸Šä¼ åŠŸèƒ½æŠ½ç¦»æˆä¸€ä¸ªç»„ä»¶ï¼Œé‚£ä¹ˆ Home é¡µé¢å°±å¾ˆä¹±äº†ï¼Œè€Œè¿™ä¹Ÿä½“ç°ä¸äº†ä½¿ç”¨ React çš„ä¼˜åŠ¿äº†ï¼

ğŸ’¡ï¼šéå—æ§è¡¨å•ï¼Ÿ

æ‰€è°“å—æ§å’Œéå—æ§ï¼ŒæŒ‡çš„æ˜¯æˆ‘ä»¬å¯¹æŸä¸ªç»„ä»¶çŠ¶æ€çš„æŒæ§ï¼Œå¦‚æœå®ƒçš„å€¼åªèƒ½ç”±ç”¨æˆ·è®¾ç½®ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨ Web åº”ç”¨çš„äººï¼Œé‚£ä¹ˆè¿™ä¸ªç»„ä»¶çš„çŠ¶æ€æ˜¯ã€Œ**éå—æ§**ã€çš„ï¼Œå¦‚æœå¼€å‘è€…å¯ä»¥é€šè¿‡ JS ä»£ç æ¥æ§åˆ¶ç»„ä»¶çš„çŠ¶æ€ï¼Œé‚£ä¹ˆè¿™ä¸ªç»„ä»¶å°±æ˜¯ã€Œ**å—æ§**ã€çš„

> åœ¨ HTML çš„è¡¨å•å…ƒç´ ä¸­ï¼Œå®ƒä»¬é€šå¸¸è‡ªå·±ç»´æŠ¤ä¸€å¥—`state`ï¼Œå¹¶éšç€ç”¨æˆ·çš„è¾“å…¥è‡ªå·±è¿›è¡Œ`UI`ä¸Šçš„æ›´æ–°ï¼Œè¿™ç§è¡Œä¸ºæ˜¯ä¸è¢«æˆ‘ä»¬ç¨‹åºæ‰€ç®¡æ§çš„ã€‚è€Œå¦‚æœå°†`React`é‡Œçš„`state`å±æ€§å’Œè¡¨å•å…ƒç´ çš„å€¼å»ºç«‹ä¾èµ–å…³ç³»ï¼Œå†é€šè¿‡`onChange`äº‹ä»¶ä¸`setState()`ç»“åˆæ›´æ–°`state`å±æ€§ï¼Œå°±èƒ½è¾¾åˆ°æ§åˆ¶ç”¨æˆ·è¾“å…¥è¿‡ç¨‹ä¸­è¡¨å•å‘ç”Ÿçš„æ“ä½œã€‚è¢«`React`ä»¥è¿™ç§æ–¹å¼æ§åˆ¶å–å€¼çš„è¡¨å•è¾“å…¥å…ƒç´ å°±å«åš**å—æ§ç»„ä»¶**ã€‚

å—æ§ç»„ä»¶ç‰¹ç‚¹ -> éœ€è¦å•ç‹¬çš„ä¸ºæ¯ä¸ªè¡¨å•å…ƒç´ ç»´æŠ¤ä¸€ä¸ªçŠ¶æ€

è€Œéå—æ§ç»„ä»¶ -> åˆ©ç”¨`ref`å±æ€§ï¼Œå¯ä»¥è·å– `input` å…ƒç´ çš„ `DOM` å±æ€§ä¿¡æ¯ï¼Œå¦‚è·å–ç”¨æˆ·è¾“å…¥çš„å€¼ -> ç”¨`defaultValue`å±æ€§æ¥æŒ‡å®šè¡¨å•å…ƒç´ çš„é»˜è®¤å€¼

**å¯¹äº file ç±»å‹çš„è¡¨å•æ§ä»¶å®ƒå§‹ç»ˆæ˜¯ä¸€ä¸ªä¸å—æ§åˆ¶çš„ç»„ä»¶ï¼Œå› ä¸ºå®ƒçš„å€¼åªèƒ½ç”±ç”¨æˆ·è®¾ç½®ï¼Œè€Œä¸æ˜¯ä»¥ç¼–ç¨‹æ–¹å¼è®¾ç½®ã€‚**

é’ˆå¯¹`type`ç±»å‹çš„`file`çš„`input`å…ƒç´ ï¼Œä½ è¦ç”¨éå—æ§ç»„ä»¶çš„æ–¹å¼å»è·å–å®ƒçš„å€¼ï¼ -> è¿™å°±æ˜¯ä½¿ç”¨`const ref = useRef()`çš„åŸå› ï¼

æ€»ä¹‹ä½ ä¸èƒ½é€šè¿‡è¿™æ ·ï¼š

``` jsx
<input type="file" value={this.state.files} onChange={(e) => this.handleFile(e)} />
```

å»æ”¹å˜è¿™ä¸ªå…ƒç´ çš„å€¼ï¼

> file è¡¨å•å…ƒç´ çš„å€¼æ˜¯`fileRef.current.files` -> `files`ï¼ˆä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶ï¼Œæ˜¯ä¸ªæ•°ç»„ï¼Œæ²¡å¼€å¯å¤šé€‰`multiple`çš„è¯ï¼Œé‚£ä¹ˆ`files`çš„é•¿åº¦å§‹ç»ˆä¸º`1`ï¼‰

æ€»ä¹‹ï¼š

React çš„å®˜æ–¹è¯´æ³•æ˜¯ï¼šç»å¤§éƒ¨åˆ†æ—¶å€™æ¨èä½¿ç”¨`å—æ§ç»„ä»¶`æ¥å®ç°è¡¨å•ï¼Œå› ä¸ºåœ¨å—æ§ç»„ä»¶ä¸­ï¼Œè¡¨å•æ•°æ®ç”±`React`ç»„ä»¶è´Ÿè´£å¤„ç†ï¼›å½“ç„¶å¦‚æœé€‰æ‹©`å—æ§ç»„ä»¶`çš„è¯ï¼Œè¡¨å•æ•°æ®å°±ç”±`DOM`æœ¬èº«å¤„ç†äº†ã€‚

â¹ï¼š[å—æ§å’Œéå—æ§ç»„ä»¶çœŸçš„é‚£ä¹ˆéš¾ç†è§£å—ï¼Ÿ(React å®é™…æ¡ˆä¾‹è¯¦è§£ï¼‰](https://juejin.cn/post/6858276396968951822#heading-7)

ğŸ’¡ï¼š`onChange`äº‹ä»¶ï¼Ÿ

ç›‘å¬è¾“å…¥å†…å®¹çš„æ”¹å˜

â¹ï¼š[ä½ çœŸçš„äº†è§£ onChange äº‹ä»¶å— - çŸ¥ä¹](https://zhuanlan.zhihu.com/p/168718667)

ğŸ’¡ï¼šIDL å±æ€§ï¼Ÿ

![IDL](assets/img/2021-04-10-01-30-48.png)

æˆ‘å¾ˆå¥½å¥‡ä¸ºå•¥æ˜¯ç”¨`files`æ¥è·å–å…ƒç´ çš„å†…å®¹ï¼Ÿè€Œä¸æ˜¯ç”¨`value`å‘¢ï¼Ÿ

â¹ï¼š[Browser APIs Â· è¯­é›€](https://www.yuque.com/wendraw/fe/browser-api)

â¹ï¼š[Web æŠ€å·§ï¼ˆ07ï¼‰. åœ¨è¿™ä¸€æœŸä¸­å’±ä»¬ä¸€èµ·æ¥èŠèŠ HTML5 ä¸­çš„è¡¨å•ã€‚è¯´åˆ° HTML](https://w3cplus.medium.com/web%E6%8A%80%E5%B7%A7-07-73e856f9e2f4)

2ï¼‰ä½¿ç”¨ antd ä¸Šä¼ ç»„ä»¶å®ç°ç‚¹å‡»å’Œæ‹–æ‹½ä¸Šä¼ 

> æ–‡æ¡£ï¼š[ä¸Šä¼  Upload - Ant Design](https://ant.design/components/upload-cn/)

![ä¸Šä¼ ç»„ä»¶](assets/img/2021-04-10-19-46-26.png)

æœ€ç»ˆå®ç°çš„æ•ˆæœï¼š

![å®ç°æ•ˆæœ](assets/img/2021-04-11-13-21-27.png)

ä»£ç ï¼š

``` jsx
import React from "react";
import { useStores } from "../stores";
import { observer } from "mobx-react";

import { Upload } from "antd";
import { InboxOutlined } from "@ant-design/icons";

const { Dragger } = Upload;

const Component = observer(() => {
  const { ImageStore } = useStores();

  const props = {
    showUploadList: true,
    beforeUpload: (file) => {
      ImageStore.setFile(file);
      ImageStore.setFilename(file.name);
      // å¼‚æ­¥æ“ä½œ
      ImageStore.upload()
        .then((serverFile) => console.log("ä¸Šä¼ æˆåŠŸ", serverFile))
        .catch((err) => console.log(err));
      // å…ˆç»“æŸ
      return false;
    },
  };

  return (
    <div>
      <Dragger {...props}>
        <p className="ant-upload-drag-icon">
          <InboxOutlined />
        </p>
        <p className="ant-upload-text">
          Click or drag file to this area to upload
        </p>
        <p className="ant-upload-hint">
          Support for a single or bulk upload. Strictly prohibit from uploading
          company data or other band files
        </p>
      </Dragger>
      <div>
        <h1>ä¸Šä¼ ç»“æœ</h1>
        {ImageStore.serverFile ? (
          <div>{ImageStore.serverFile.attributes.url.attributes.url}</div>
        ) : null}
      </div>
    </div>
  );
});

export default Component;
```

è§£æï¼š

`showUploadList`ï¼šå®ƒçš„å€¼ä¸º`true`ï¼Œé‚£å°±å±•ç¤ºè¿™ä¸ªï¼š

![showUploadList](assets/img/2021-04-11-13-31-24.png)

æœ‰ç§è®°å½•æœ¬åœ°ä¸Šä¼ å†å²çš„è°ƒè°ƒâ€¦â€¦

`beforeUpload`ï¼šæ˜¯ä¸ªé’©å­ï¼Œåœ¨ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨ä¹‹å‰è§¦å‘ï¼Œå…¶å®å°±æ˜¯ç»™ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨è¿™ä¸ªæ“ä½œç”¨çš„ï¼ï¼ˆ`resolve` æ—¶å¼€å§‹ä¸Šä¼ ã€è¿”å›`false`å°±åœæ­¢æ–‡ä»¶ä¸Šä¼ ï¼‰ -> æˆ‘ä»¬ä»æœ¬åœ°æŠŠæ–‡ä»¶æ‹–è¿›å»ï¼Œç›¸å½“äºç»™è¿™ä¸ªç›’å­è¾“å…¥äº†ä¸€ä¸ªæ–‡ä»¶ -> æ–‡ä»¶è¾“å…¥åï¼Œå°±å¯ä»¥ç€æ‰‹æŠŠæ–‡ä»¶ä¸Šä¼ åˆ°æœåŠ¡å™¨çš„äº‹å„¿äº†ï¼

ğŸ’¡ï¼š`ImageStore.serverFile.attributes.url.attributes.url`ï¼Ÿ

![serverFile](assets/img/2021-04-11-13-46-24.png)

3ï¼‰è‡ªå®šä¹‰ Tips ç»„ä»¶å®ç°ç™»å½•åä¸Šä¼ é™åˆ¶

ç›®å‰å¯Ÿè§‰åˆ°çš„é—®é¢˜ï¼šã€Œä¸ç™»å½•ï¼Œä¹Ÿèƒ½ä¸Šä¼ å›¾ç‰‡ã€

![ä¸ç™»å½•ä¸Šä¼ å›¾ç‰‡](assets/img/2021-04-11-13-53-31.png)

> ä¸èƒ½è®©æ‰€æœ‰ç”¨æˆ·éƒ½å¯ä»¥æ— é™ä¸Šä¼ ï¼Œä¸ç„¶è¿™å…è´¹çš„ APIï¼Œå°±å‡‰å‡‰äº†â€¦â€¦

ç”¨åˆ°çš„ç¬¬ä¸‰æ–¹ç»„ä»¶ï¼š`Message` -> æ–‡æ¡£ï¼š[å…¨å±€æç¤º Message - Ant Design](https://ant.design/components/message-cn/)

è‡ªå®šä¹‰çš„ `Tips` ç»„ä»¶ï¼š

![Tips ç»„ä»¶](assets/img/2021-04-11-19-30-29.png)

ä»£ç ï¼š

``` jsx
import React from "react";
import { useStores } from "../stores";
import { observer } from "mobx-react";
import styled from "styled-components";

const Tips = styled.div`
  padding: 10px;
  margin: 30px 0;
  color: #fff;
  border-radius: 4px;
  background-color: orange;
`;

const Component = observer(({ children }) => {
  const { UserStore } = useStores();
  return <>{UserStore.currentUser ? null : <Tips>{children}</Tips>}</>;
});

export default Component;
```

å…³é”®ä»£ç ï¼š

![å…³é”®ä»£ç ](assets/img/2021-04-11-19-31-35.png)

ğŸ’¡ï¼šæ¶ˆæ¯å¼¹å‡ºæ¡†é»˜è®¤ä¼šåœç•™å¤šä¹…æ‰ä¼šæ¶ˆå¤±ï¼Ÿ

é»˜è®¤æ˜¯ 3 sï¼

4ï¼‰ä¸Šä¼ ç»“æœå±•ç¤º

è¦åšçš„ï¼š

![ä¸Šä¼ ç»“æœ](assets/img/2021-04-11-22-37-12.png)

è¦å±•ç¤ºå›¾ç‰‡çš„å“ªäº›ä¿¡æ¯å‘¢ï¼Ÿ



